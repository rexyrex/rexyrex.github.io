<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex Typing Game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/typespeed2.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  </head>

  <body>
    <div class="container">
      <!-- Header Section -->
      <div class="game-card text-center header-section">
        <div class="title-container">
          <h1 class="main-title">Rexyrex</h1>
          <h2 class="subtitle">íƒ€ì ì†ë„ ì¸¡ì •ê¸°</h2>
          <div class="title-accent-line"></div>
        </div>
        <div class="version-info">
          <span id="verTitle" class="version-badge">Ver </span>
          <a class="version-link" onclick="openVersionModal()">[ë²„ì „ ì´ë ¥]</a>
        </div>
      </div>

      <!-- Main Game Section -->
      <div id="grp1" class="game-card">
        <!-- Mode Selection -->
        <div class="mode-selection-section" id="modeSelectionSection">
          <h3 class="mode-title">ê²Œì„ ëª¨ë“œ ì„ íƒ</h3>
          <div class="mode-selector" id="modeGrp" data-toggle="buttons">
            <button id="chMod1" type="button" class="mode-btn btn-choice" onclick="changeMode(1)">
              <span class="mode-btn-text">í•œíƒ€</span>
              <span class="mode-btn-desc">í•œê¸€ íƒ€ì</span>
            </button>
            <button id="chMod2" type="button" class="mode-btn btn-choice" onclick="changeMode(2)">
              <span class="mode-btn-text">ì´í¬ë„·</span>
              <span class="mode-btn-desc">íšŒì‚¬ ëª¨ë“œ</span>
            </button>
            <button id="chMod3" type="button" class="mode-btn btn-choice" onclick="changeMode(3)">
              <span class="mode-btn-text">ì˜íƒ€</span>
              <span class="mode-btn-desc">English</span>
            </button>
            <button id="chMod4" type="button" class="mode-btn btn-choice" onclick="changeMode(4)">
              <span class="mode-btn-text">ê°œë°œì</span>
              <span class="mode-btn-desc">Programming</span>
            </button>
          </div>
        </div>

        <!-- Menu Content Container -->
        <div id="menuContent">
          <!-- Start Button - Prominently displayed -->
          <div class="start-section text-center mb-4">
            <button id="startBtn" class="modern-btn btn-primary btn-large glow-on-hover start-game-btn" onclick="startCountDown()">ì‹œì‘</button>
            <p class="text-muted mt-2" style="font-size: 0.875rem;">ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
          </div>
        </div>

        <!-- Game Area (initially hidden, will replace menu content) -->
        <div id="grp2" class="game-area" style="display: none;">
          <!-- Progress Bar -->
          <div id="prgBar" class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" aria-valuenow="75" aria-valuemin="0" 
                 aria-valuemax="100" style="width: 0%;">0%</div>
          </div>
          
          <!-- Text Display Areas -->
          <div class="text-display">
            <div class="mb-3">
              <span id="testSentInputBefore" class="testSentInputSecondary text-display unselectable" style="pointer-events:none; opacity:0.27;"></span>
            </div>
            
            <div class="mb-3">
              <span id="testSentInput" class="testSentInput text-display unselectable" style="pointer-events:none;"></span>
            </div>
            
            <div class="mb-4">
              <span id="testSentInputAfter" class="testSentInputSecondary text-display unselectable" style="pointer-events:none; opacity:0.27;"></span>
            </div>
            
            <!-- Input Field -->
            <div class="mb-3">
              <input id="chatInput" class="form__input2" autocomplete="off" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..."/>
            </div>

            <!-- Comment Display -->
            <div class="text-center">
              <p id="comment" style="visibility:hidden; font-size:1.5rem; font-weight: 600; color: var(--accent-color);">ddd</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Rankings Section - Separated from main game -->
      <div class="rankings-section">
        <div class="game-card">
          <h3 class="rankings-title">ğŸ† ìˆœìœ„í‘œ</h3>
          <div class="row">
            <div class="col-md-6 mb-2">
              <button id="highScoreBtnDaily" class="modern-btn btn-secondary w-100 ranking-btn" onclick="openHighscoresModal(true)">
                <div class="ranking-btn-content">
                  <div class="ranking-btn-icon">ğŸ“…</div>
                  <div class="ranking-btn-text">
                    <div class="ranking-btn-title">ì˜¤ëŠ˜ ìˆœìœ„</div>
                    <div class="ranking-btn-subtitle">Today's Rankings</div>
                  </div>
                </div>
              </button>
            </div>
            <div class="col-md-6 mb-2">
              <button id="highScoreBtnAll" class="modern-btn btn-secondary w-100 ranking-btn" onclick="openHighscoresModal(false)">
                <div class="ranking-btn-content">
                  <div class="ranking-btn-icon">ğŸ†</div>
                  <div class="ranking-btn-text">
                    <div class="ranking-btn-title">ì—­ëŒ€ ìˆœìœ„</div>
                    <div class="ranking-btn-subtitle">All Time Rankings</div>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Result Modal -->
      <div id="testModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="resultModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resultModalTitle">ğŸ‰ ê²°ê³¼</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="text-center mb-4">
                <h3 id="resGrade" class="mb-2">ë“±ê¸‰:</h3>
                <h3 id="resScore" class="mb-2">ì ìˆ˜:</h3>
                <h3 id="resComp" class="mb-2">ìƒëŒ€ í‰ê°€:</h3>
                <h3 id="resAccuracy" class="mb-3">ì •í™•ë„:</h3>
              </div>

              <div class="text-center mb-3">
                <button id="openSaveCollapseBtn" onclick="openSaveCollapseBtn()" class="modern-btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  ğŸ“Š ê¸°ë¡ ì €ì¥
                </button>
              </div>

              <div class="collapse" id="collapseExample">
                <div class="card bg-dark border-secondary mb-3">
                  <div class="card-body">
                    <div class="form-group">
                      <label for="highscoreId" class="text-light">ì´ë¦„</label>
                      <input id="highscoreId" class="form-control bg-dark text-light border-secondary" autocomplete="off" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" />
                    </div>
                    <button class="modern-btn btn-primary w-100" type="button" onclick="saveHighscore();">âœ… ê¸°ë¡ ì €ì¥</button>
                  </div>
                </div>
              </div>

              <div class="text-center mb-3">
                <button class="modern-btn btn-secondary" type="button" data-toggle="collapse" data-target="#collapseExample2" aria-expanded="false" aria-controls="collapseExample2">
                  âŒ í‹€ë¦° ë‹¨ì–´ ëª©ë¡
                </button>
              </div>

              <div class="collapse" id="collapseExample2">
                <div class="redoutline">
                  <ul id="incList" style="list-style-type: none; padding: 0;"></ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
              <button type="button" class="modern-btn btn-primary" data-dismiss="modal" onclick="startCountDown()">ğŸ”„ ì¬ë„ì „!</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Highscore Modal -->
      <div id="highscoreModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="highscoreModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="highscoreModalTitle">ğŸ† íƒ€ì ì†ë„ ìˆœìœ„</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            
            <div class="modal-body">
              <nav class="nav nav-pills nav-justified mb-3">
                <a id="korScoreTab" class="nav-item nav-link active" href="#">í•œíƒ€</a>
                <a id="engScoreTab" class="nav-item nav-link" href="#">ì˜íƒ€</a>
                <a id="prgScoreTab" class="nav-item nav-link" href="#">ê°œë°œì</a>
              </nav>

              <h4 id="scoreTitle" class="text-center mb-3 p-3 bg-dark text-light rounded">í•œíƒ€ ìˆœìœ„</h4>

              <p class="text-center text-muted mb-3">(100ìœ„ ê¹Œì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.)</p>

              <div class="tableFixHead">
                <table id="highScoreTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col">ìˆœìœ„</th>
                      <th scope="col">ì´ë¦„</th>
                      <th scope="col">ë“±ê¸‰</th>
                      <th scope="col">ì ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <h3 id="highLoading" class="text-center" style="visibility:hidden;">â³ Loading...</h3>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Version Modal -->
      <div id="versionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="versionModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="versionModalTitle">ğŸ“‹ Version History</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="tableFixHead">
                <table id="versionTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col">ë²„ì „</th>
                      <th scope="col">ë³€ê²½ ì‚¬í•­</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyANe3HNZoH-3vYVA4tyZRLA_qmsPYmfvbE",
        authDomain: "rextypingspeed.firebaseapp.com",
        projectId: "rextypingspeed",
        storageBucket: "rextypingspeed.appspot.com",
        messagingSenderId: "329903137752",
        appId: "1:329903137752:web:749c515f41a710b265c8ad",
        measurementId: "G-77L95J37F1"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>


    <script>

    var db;
    
    var progress;
    var secondsPassed;
    var timeLimit;
    var started;
    var keyPressCount;
    var keyPressCountTmp;
    
    var correctWordCount;
    var incorrectWordCount;
    
    var incWordArr;
    var attmpWordArr;

    var timerStartedOnce;

    var startSentenceTime;

    var score;
    var accuracy;

    var scoreSaved;

    var sentenceTriplet;
    var prevInputSent;

    var countingDown;

    var mode;

    var daily = false;

    const cheatDetect = [];

    var givenSentenceList;
    var typedSentenceList;

    const keyMap= new Map();

    const version = 8;

    var uuid = uuidv4();
    
    var level = [
      {"s" : 200, "l" : 'ì£„ì†¡í•œë°... ì†ê°€ë½ 2ê°œì„¸ìš”?'}, 
      {"s" : 300, "l" : 'ë¶„ë°œí•˜ì…”ì•¼ê² ì–´ìš”'}, 
      {"s" : 380, "l" : 'ì´ì •ë„ë©´ í‰íƒ€'}, 
      {"s" : 420, "l" : 'í‰ê·  ì´ìƒ'}, 
      {"s" : 470, "l" : 'ë¹ ë¥¸í¸'}, 
      {"s" : 520, "l" : 'ê°œë°œì'}, 
      {"s" : 560, "l" : 'pcì¹´í†¡ ë§ì´ í•œê±° í‹°ë‚˜ë„¤ (ì„í¬ì£¼ê¸‰)'}, 
      {"s" : 600, "l" : 'íƒ€ì ë§ê³  ì˜í•˜ëŠ”ê²Œ ì—†ì„ í™•ë¥  ë†’ìŒ'}, 
      {"s" : 650, "l" : 'ëŒ€íšŒ ë‚˜ê°€ë„ ë ë“¯'}, 
      {"s" : 700, "l" : 'íƒ€ì ì‹ '}, 
      {"s" : 740, "l" : 'í•´í‚¹ ìœ ì €'},
      {"s" : 780, "l" : 'ê¸°ê³„'},
      {"s" : 820, "l" : 'ì´ˆì›”ì'},
      {"s" : 999999, "l" : 'ë ìš©'}
    ];

    var englevel = [
      {"s" : 20, "l" : 'Slowpoke'}, 
      {"s" : 30, "l" : 'Practice makes perfect'}, 
      {"s" : 40, "l" : 'Not bad'}, 
      {"s" : 50, "l" : 'Above Average'}, 
      {"s" : 60, "l" : 'Quite fast'}, 
      {"s" : 70, "l" : 'Developer'}, 
      {"s" : 80, "l" : 'Bunny Typer'}, 
      {"s" : 90, "l" : 'Professional Typer'}, 
      {"s" : 100, "l" : 'Typing God'}, 
      {"s" : 110, "l" : 'Hacker'},
      {"s" : 120, "l" : 'Machine'},
      {"s" : 130, "l" : 'Ridonculous'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    var prglevel = [
      {"s" : 20, "l" : 'ë°±ìˆ˜'}, 
      {"s" : 27, "l" : 'ì‹ ì…'}, 
      {"s" : 32, "l" : 'ì£¼ì„'}, 
      {"s" : 38, "l" : 'ëŒ€ë¦¬'}, 
      {"s" : 45, "l" : 'ê³¼ì¥'}, 
      {"s" : 52, "l" : 'ì°¨ì¥'}, 
      {"s" : 59, "l" : 'ë¶€ì¥'}, 
      {"s" : 65, "l" : 'ì´ì‚¬'}, 
      {"s" : 70, "l" : 'ì‚¬ì¥'}, 
      {"s" : 75, "l" : 'íšŒì¥'}, 
      {"s" : 80, "l" : 'ëŒ€í†µë ¹'},
      {"s" : 85, "l" : 'Elon Musk'},
      {"s" : 90, "l" : 'ë‡Œë¡œ í”„ë¡œê·¸ë˜ë°í•˜ëŠ” ì™¸ê³„ì¸'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    const scoreTabs = ['korScoreTab','engScoreTab', 'prgScoreTab'];
    
    $(function () {

      $('#korScoreTab').on('click', function (e) {
        setScoreTab('kor');
      })

      $('#engScoreTab').on('click', function (e) {
        setScoreTab('eng');
      })

      $('#prgScoreTab').on('click', function (e) {
        setScoreTab('prg');
      })

      $('#verTitle').text("Ver " + version);
      changeMode(1);
      db = firebase.firestore();
      saveLogin();
      checkVersion();
      timerStartedOnce = false;
      reset();

      //var textgen = new TextGen();
      //alert(textgen.sentence());
    });

    function setScoreTab(tabType){
      if(tabType=='kor'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("í•œíƒ€ ìˆœìœ„" + (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#korScoreTab').addClass('active');
        loadHighscoreData('kor');
      } else if(tabType=='eng'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("English Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#engScoreTab').addClass('active');
        loadHighscoreData('eng');
      } else if(tabType=='prg'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("Programmer Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#prgScoreTab').addClass('active');
        loadHighscoreData('prg');
      }
    }

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function saveLogin(){
      db.collection("login").add({
            uuid: uuid,
            navigator: navigator.userAgent,
            date: moment().format('MM-DD-YYYY HH:mm:ss')
          }).then((docRef) => {
            
          })
          .catch((error) => {

          });
    }

    function checkVersion(){
      db.collection("version").orderBy("ver", "desc").limit(1)
      .get()
      .then((querySnapshot) => {
          var serverVer = 100000;
          querySnapshot.forEach((doc) => {
              serverVer = parseInt(doc.data().ver);
          });

          if(version < serverVer){
            alert("ìºì‹œë¥¼ ì§€ì›Œì£¼ì„¸ìš”. (Client ver: " + version + ", Server ver: " + serverVer + ")");
            //window.location.reload(true);
            $('#startBtn').text("ìºì‹œë¥¼ ì§€ì›Œì£¼ì„¸ìš”.");
            $('#startBtn').attr('disabled', true);

            fadeOut("grp2");
            fadeOut("highScoreBtnDaily");
            fadeOut("highScoreBtnAll")
            fadeOut("modeGrp");
          }

      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }

    function openVersionModal(){
      $('#versionModal').modal('show');

      db.collection("version").orderBy("ver", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var versionList = [];
          querySnapshot.forEach((doc) => {
              //console.log(doc.id, " => ", doc.data());
              versionList.push(doc.data());
          });

          $('#versionTable tbody').empty();
          for(var i=0; i<versionList.length; i++){
            $('#versionTable tbody').append("<tr><td>" + versionList[i].ver + "</td><td>"+ versionList[i].desc + "</td>");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });

    }

    function changeMode(m){
      // if(m==4){
      //   alert("ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤");
      //   return;
      // }
      mode = m;
      
      // Remove active class from all mode buttons
      $('.mode-btn').removeClass('active');
      
      // Add active class to selected mode button
      $('#chMod'+m).addClass('active');
    }

    function openSaveCollapseBtn(){
      $('#openSaveCollapseBtn').css("visibility", "hidden");
    }

    function updateSentenceTriplet(){
      if(sentenceTriplet.length == 0){
        sentenceTriplet.push(generateSentence());
        sentenceTriplet.push(generateSentence());
        sentenceTriplet[2] = '.';
      } else {
        //triplet is of length 2 or 3
        sentenceTriplet[2] = sentenceTriplet[1];
        sentenceTriplet[1] = sentenceTriplet[0];
        sentenceTriplet[0] = generateSentence();
      }
    }

    function saveHighscore(){
      if($('#highscoreId').val().length < 2){
        alert("ì´ë¦„ì´ ë„ˆë¬´ ì§§ì•„ìš”.");
        return;
      } else if($('#highscoreId').val().length > 8){
        alert("ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”.");
        return;
      }

      if(score<0 || isNaN(score)){
        alert("ê¸°ë¡ ì €ì¥ ë¶ˆê°€ - í•œ ë‹¨ì–´ë„ ì•ˆì¹˜ì…¨ë„¤ìš” :(");
      }

      if(!scoreSaved){
        scoreSaved = true;
        addHighscore($('#highscoreId').val(), score, getGrade(), Math.round(accuracy*100)+'%');   
        updateAnonHighscore();     
      } else {
        alert("ì´ë¯¸ ê¸°ë¡ ì €ì¥í•˜ì…¨ë„¤ìš”~");
      }
    }

    function addAnonHighscore(score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      db.collection(collectionName).add({
            uuid: uuid,
            id: "",
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            
          })
          .catch((error) => {
            console.log("error:");
            console.log(error);
          });
    }

    function updateAnonHighscore(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      var tmpId = $('#highscoreId').val();
      db.collection(collectionName).where("uuid", "==", uuid).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          db.collection(collectionName).doc(doc.id).update({
              id: tmpId,
          })
          .then(() => {
            
          })
        })
      })
    }

    function addHighscore(username, score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var userExists = false;
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      //Check if username exists
      db.collection(collectionName).where("id", "==", username).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            userExists = true;
            //console.log(doc.id, " => ", doc.data());
            //username exists and new highscore reached
            if(doc.data().score < score){
              db.collection(collectionName).doc(doc.id).update({
                  score: score,
                  accuracy: accuracy,
                  correctWordCount : correctWordCount,
                  incorrectWordCount : incorrectWordCount,
                  givenSentenceList : givenSentenceList,
                  typedSentenceList : typedSentenceList,
                  keyMap : keyArr,
                  rank: rank,
                  clientVersion: version,
                  mode: mode,
                  cheatDetect: cheatDetect,
                  keyPressCount: keyPressCount,
                  keyPressCountTmp: keyPressCountTmp,
                  date: moment().format('MM-DD-YYYY HH:mm'),
                  day: moment().format('MM-DD-YYYY')
              })
              .then(() => {
                alert("ê¸°ë¡ ê°±ì‹ í•˜ì…¨ìŠµë‹ˆë‹¤! (" + doc.data().score + " => " + score + ")");
              })
            } else {
              alert("ë” ë†’ì€ ê¸°ë¡ì´ ìˆìœ¼ì„¸ìš”. ê¸°ë¡ ê°±ì‹  ì‹¤íŒ¨. (" + doc.data().score + ")");
            }
        });
        //Add new user
        if(!userExists){
          db.collection(collectionName).add({
            id: username,
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            alert("ì €ì¥ ì™„ë£Œ");
          })
          .catch((error) => {
            alert("ì—ëŸ¬ ë°œìƒ");
          });
        }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }

    function openHighscoresModal(dly){

      daily = dly;

      $('#highLoading').css("visibility", "visible");
      
      setScoreTab('kor');

      $('#highscoreModal').modal('show');
    }

    function loadHighscoreData(scoreType){
      var collectionName = '';
      if(!daily){
        if(scoreType=='kor'){
          collectionName = "records2";
        } else if(scoreType == 'eng'){
          collectionName = "engRecords";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecords";
        }
      } else {
        //daily
        if(scoreType=='kor'){
          collectionName = "recordsAnon";
        } else if(scoreType == 'eng'){
          collectionName = "engRecordsAnon";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecordsAnon";
        }
      }

      if(!daily){
        db.collection(collectionName).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#highScoreTable tbody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + highList[i].id + "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      } else {
        //daily
        db.collection(collectionName).where("day", "==", moment().format('MM-DD-YYYY')).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#highScoreTable tbody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + (highList[i].id == '' ?  'ìµëª… ìœ ì €' : highList[i].id)+ "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      }
      
    }

    function checkRank(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      db.collection(collectionName).orderBy("score", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var highList = [];
         var i = 0;
         var place = 101;
         var tmpSaved = false;
          querySnapshot.forEach((doc) => {
              highList.push(doc.data());
              i+=1;
              if(score>doc.data().score && !tmpSaved){
                tmpSaved = true;
                place = i;
              }
          });

          if(place < 101){
            $('#resComp').text("ìƒëŒ€ í‰ê°€ : ìƒìœ„" + Math.round(place/i*100) + "% (" + i + "ëª… ì¤‘ " + place + "ë“±)" );
            alert("ì´ " + i + "ëª… ì¤‘ " + place + "ë“± í•˜ì…¨ì–´ìš”!\n[ê¸°ë¡ ì €ì¥]ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìˆœìœ„ê¶Œì— ì˜¬ë¼ê°€ì„¸ìš”!");
          } else if(i < 101){
            $('#resComp').text("ìƒëŒ€ í‰ê°€ : " + i + "ëª… ì¤‘ ê¼´ë“±");
            alert("ì´ " + i + "ëª… ì¤‘ ê¼´ë“± í•˜ì…¨ì–´ìš”!\n[ê¸°ë¡ ì €ì¥]ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìˆœìœ„ê¶Œì— ì˜¬ë¼ê°€ì„¸ìš”!");
          } else {
            $('#resComp').text("ìƒëŒ€ í‰ê°€ : 100ë“± ì•ˆì— ëª»ë“¤ì—ˆì–´ìš”");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }
    
    function reset(){
      console.log('Reset called - before reset: secondsPassed:', secondsPassed, 'started:', started);
      
      uuid = uuidv4();

      started = false;
      countingDown = false;
      progress = 0;
      secondsPassed = 0;
      keyPressCount = 0;
      keyPressCountTmp = 0;
      timeLimit = 60;
      scoreSaved = false;
      
      correctWordCount = 0;
      incorrectWordCount = 0;
      score = 0;
      accuracy = 0;
      incWordArr = [];
      attmpWordArr = [];

      sentenceTriplet = [];
      prevInputSent = "";

      typedSentenceList = [];
      givenSentenceList = [];

      keyMap.clear();
      
      console.log('Reset completed - after reset: secondsPassed:', secondsPassed, 'started:', started);
      
      // Clear content and animations
      $('#testSentInput').html('');
      $('#testSentInputBefore').html('');
      $('#testSentInputAfter').html('');
      $('#chatInput').val('');
      
      // Reset progress bar
      $(".progress-bar").css("width", "0%").text("60").css('background', 'var(--success-color)');
      
      // Reset all animation classes and structure
      $('#menuContent').removeClass('menu-fade-out').show();
      $('#modeSelectionSection').removeClass('menu-fade-out');
      $('.rankings-section').removeClass('menu-fade-out');
      $('#grp2').removeClass('game-start-transition').hide();
      $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
      $('#testSentInput').removeClass('text-reveal');
      $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
      $('#chatInput').removeClass('input-focus-ready');
      $('#startBtn').removeClass('countdown-pulse').text("ì‹œì‘");
      
      // Clear any comment visibility
      $('#comment').css("visibility", "hidden");
    }

    function retry(){
      reset();
      // Don't call start() directly, let startCountDown() handle the flow
    }

    function fadeIn(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      //animate(elemId, "animateFadeIn", function(){$('#' + elemId).css("visibility", "visible").css("opacity", 1);});
      $('#' + elemId).transition({opacity:1},4000, "snap"); 
    }

    function fadeIn2(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      $('#' + elemId).transition({opacity:0.27},4000, "snap");
    }

    function fadeOut(elemId){
      $('#' + elemId).css("opacity", 1);
      $('#' + elemId).transition({opacity:0}, 4000, "snap", function(){$('#' + elemId).css("visibility", "hidden").css("opacity", 0);});
    }

    function animate(elemId, anim, fn){
      //console.log("animating : " + elemId + ", " + anim);
      $('#' + elemId).addClass(anim);
      $('#' + elemId).on("animationend", function(){
        fn();
        $(this).removeClass(anim);
      });
    }

    function startCountDown(){
      $('#chatInput').html('');
      
      // Debug logging
      console.log('startCountDown called - started:', started, 'countingDown:', countingDown);
      
      // If this is a retry (button says "ì¬ë„ì „"), reset the game state first
      if($('#startBtn').text() === "ì¬ë„ì „") {
        console.log('This is a retry - calling reset first');
        reset();
      }

      if(!started && !countingDown){
        console.log('Starting countdown...');
        
        // Hide other menu elements but keep the start button for countdown
        $('#modeSelectionSection').addClass('menu-fade-out');
        $('.rankings-section').addClass('menu-fade-out');
        
        countingDown = true;

        var counter = 5;
        $('#startBtn').text(counter).addClass('countdown-pulse');
        
        var counterItv = setInterval(function(){ 
          counter-=1;
          $('#startBtn').text(counter);
          
          if(counter==0){
            clearInterval(counterItv);
            countingDown = false;
            
            // Now hide the entire menu content and show game
            $('#menuContent').addClass('menu-fade-out');
            
            // Start the game after menu fades out
            setTimeout(() => {
              $('#menuContent').hide();
              
              // Prepare game content BEFORE showing the game area
              updateSentenceTriplet();
              $('#testSentInputBefore').html(sentenceTriplet[0]);
              $('#testSentInput').html(sentenceTriplet[1]);
              $('#testSentInputAfter').html(sentenceTriplet[2]);
              
              // Show game area with GRANDIOSE transition
              $('#grp2').show().addClass('game-start-transition');
              
              // Always call start() for both first time and retry
              start();
            }, 500);
          }
        }, 1000);
      } else {
        // Debug: log why startCountDown is not executing
        console.log('startCountDown blocked - started:', started, 'countingDown:', countingDown);
      }
    }
    
    function start(){
      if(!started){
        started = true;
        
        // Debug: log timer state when starting
        console.log('Game starting - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
        
        // Add reveal animations to content that's already visible
        setTimeout(() => {
          $('#testSentInputBefore').addClass('text-reveal-delay-1');
          $('#testSentInput').addClass('text-reveal');
          $('#testSentInputAfter').addClass('text-reveal-delay-2');
          $('#chatInput').addClass('input-focus-ready');
        }, 200);
        
        // Focus on input after animations
        setTimeout(() => {
          $('#chatInput').focus();
        }, 1000);
        
        // Set up the game timer (only once)
        if(!timerStartedOnce){
          timerStartedOnce = true;

          setInterval(function(){ 
              if(started){
                  $('#chatInput').focus();
                  progress = secondsPassed/timeLimit * 100;  
                  var timeLeftVal = 100 - progress;
                  var color = progress < 60 ? 'var(--success-color)' : (progress < 80 ? 'var(--warning-color)' : 'var(--error-color)');
                  $(".progress-bar").css("width", timeLeftVal + "%").text(timeLimit - secondsPassed).css('background', color);
                  
                  // Debug: log timer progress
                  if(secondsPassed % 10 === 0) {
                    console.log('Timer tick - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
                  }
                  
                  secondsPassed+=1;
                  if(secondsPassed > timeLimit){
                    console.log('Timer ended - calling endLogic()');
                    endLogic();
                  }
              }
            }, 1000);
          }
        }
    }
    
    function endLogic(){
        if(started){
            started = false;

            // Hide game area
            $('#grp2').removeClass('game-start-transition').hide();
            
            // Clear all animation classes
            $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
            $('#testSentInput').removeClass('text-reveal');
            $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
            $('#chatInput').removeClass('input-focus-ready');
            
            // Clear content
            $('#testSentInput').html('');
            $('#testSentInputBefore').html('');
            $('#testSentInputAfter').html('');
            $('#chatInput').val('');

            // Show menu content again
            setTimeout(() => {
                $('#menuContent').removeClass('menu-fade-out').show();
                $('#modeSelectionSection').removeClass('menu-fade-out');
                $('.rankings-section').removeClass('menu-fade-out');
                $('#startBtn').removeClass('countdown-pulse').text("ì¬ë„ì „");
            }, 500);

            accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
            score = Math.round((keyPressCount + getEffectiveKeyPressCountTmp()) * accuracy);
            if(mode==3||mode==4){
              score = Math.round(score/5);
            }

            checkRank();

            $('#resScore').text("ì ìˆ˜ : " + score);
            $('#resGrade').text("ë“±ê¸‰ : " + "[" + getGrade() + "]");
            $('#resAccuracy').text("ì •í™•ë„ : " + Math.round(accuracy * 100) + "% (" + correctWordCount + "/" + (correctWordCount + incorrectWordCount) + ")");

            $('#incList').empty();
            for(var i=0; i<incWordArr.length; i++){
                //console.log((i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')");
                $('#incList').append('<li>' + (i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')" + '</li>')
            }

            if(!isNaN(score)){
              addAnonHighscore(score, getGrade(), accuracy);
            }            

            $('#testModal').modal('show');
        }
    }

    function getEffectiveKeyPressCountTmp(){
      if(typedSentenceList.length == 0){
        return 0;
      } else {
        var avg = Math.round(keyPressCount / typedSentenceList.length);
        if(keyPressCountTmp > avg) {
          return avg;
        } else {
          return keyPressCountTmp;
        }
      }
    }

    function checkBatchimEnding(word) {
      if (typeof word !== 'string') return null;
    
      var lastLetter = word[word.length - 1];
      var uni = lastLetter.charCodeAt(0);
    
      if (uni < 44032 || uni > 55203) return null;
    
      return (uni - 44032) % 28 != 0;
    }

    function encounterMessage(name){
      var adj = checkBatchimEnding(name)?'ì´':'ê°€';
    }

    function generateName(){
      const f = ["ê¹€", "ë°•", "ì´", "ì¥", "ì„", "ì–‘", "í•œ", "ì„œ", "ì•ˆ"];
      const s = ["í˜•", "ë¯¼", "í¬", "ì£¼", "ì„±", "í˜¸", "ê´‘", "ì²œ", "ì„¸", "í›ˆ", "ì„", "ì˜", "ì€", "ì—°", "ê²½", "ê³ ", "ìš´", "ì†Œ", "í¬", "ì •"];

      return f[ri(f.length)] + s[ri(s.length)] + s[ri(s.length)];
    }
    
    function generateSentence(){
      startSentenceTime = new Date();

      var pnouns;
      var nouns;
      var verbs;
      var adjectives;

      if(mode == 1 || mode == 2){
        pnouns = [];
        pnouns.push(generateName());
      
        nouns = ["ê°ì","ê³¼ì","ì‚¬íƒ•","ë‚™íƒ€","ì»´í“¨í„°","í‚¤ë³´ë“œ","ë‹¤ëŒì¥","ê³µë£¡","ìŠ¬ë™","í•¸ë“œí°", "ì‚¬ì§„ê¸°","ë¬¼ì»µ", "ëª¨ë‹ˆí„°", "ì°½ê³ ", "ê°•ì•„ì§€", "ê³ ì–‘ì´", "ëƒ‰ì¥ê³ ", "ë‹¤ë¦¬ë¯¸", "ì»µ", "í¬í¬", "ìˆŸê°€ë½", "ëª…í•¨", "ê³°", "ê±°ë¶ì´", "í† ë¼", "ë¹—ìë£¨", "ì‡³ë©ì–´ë¦¬", "êµ¬ìŠ¬", "ìŠ¤íŠ¸ë ˆì¹­ ë„êµ¬", "ë§ˆì‚¬ì§€ ì˜ì", "ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°", "ìœ ì„  í•¸ë“œí°", "ëª…í’ˆ ê°€ë°©", "í•˜ì´í", "ëšœë ˆì¥¬ë¥´", "ê¸€ë£¨", "ì²´ë¦¬", "ì„œë²„", "ê²½ì§€ì‹¤", "ê²½ì „ì‹¤", "ì²´ë¦¬ ê°œë°œíŒ€", "ì•¼êµ¬ ë¹ ë”°", "ì›ìˆ­ì´", "ìƒì¥", "ì¹œêµ¬", "ì‚¬ëŒ", "ëª¨ë‹¥ë¶ˆ", "ì•„ì´ìŠ¤í¬ë¦¼", "ìŠ¤í…Œì´í¬", "ë¯¸êµ­ì‚° ê³ ê¸°", "ì‚´ì•„ìˆëŠ” í•œìš°", "ì†Œ", "ê°•ì•„ì§€", "ê³ ì–‘ì´"]
        
        verbs = ["ë¨¹ì—ˆë‹¤", "ë•Œë ¸ë‹¤","ì§¸ë ¤ë´¤ë‹¤","ê±·ì–´ ì°¼ë‹¤", "ì‹«ì–´í•œë‹¤", "ì¢‹ì•„í•œë‹¤", "í˜ì˜¤í•œë‹¤", "ê³µê²©í–ˆë‹¤", "ëŒë ¤ë²„ë ¸ë‹¤", "ì‹œë„í–ˆë‹¤", "ë°•ì‚´ëƒˆë‹¤", "ì‹¸ëŒ€ê¸° ë•Œë ¸ë‹¤", "ë°˜í† ë§‰ëƒˆë‹¤", "ì³ë‹¤ë´¤ë‹¤", "íŒ¨ë²„ë ¸ë‹¤", "ìƒìƒí•´ë´¤ë‹¤", "ê°ˆê¶œë‹¤", "ë¿Œë¦¬ì³¤ë‹¤", "ê¹¨ë¬¼ì–´ë²„ë ¸ë‹¤", "ê°œë°œí–ˆë‹¤", "í•´í‚¹í–ˆë‹¤", "ë§í•˜ê²Œ í•´ë²„ë ¸ë‹¤", "ë§ê°€íŠ¸ë ¸ë‹¤", "ìœ„ì¡°í–ˆë‹¤", "ê¸°ë¶€í–ˆë‹¤", "ë°€ì–´ ëƒˆë‹¤", "ì¡ì•„ ë‹¹ê²¼ë‹¤", "ìš•í–ˆë‹¤"]

        adjectives = ["ë§›ìˆê²Œ", "í˜ì°¨ê²Œ", "ê²¨ìš°", "ì²œì²œíˆ", "ë©‹ìˆê²Œ", "ì˜ˆì˜ê²Œ", "ë¹ ë¥´ê²Œ", "ëœ¨ê²ê²Œ", "ì´ìƒí•˜ê²Œ", "ê·€ì—½ê²Œ", "ë”°ëˆí•˜ê²Œ","ì–„ë°‰ê²Œ", "ì°¨ê°‘ê²Œ", "ì–´ì¤‘ê°„í•˜ê²Œ", "ì–´ìƒ‰í•˜ê²Œ", "ë˜‘ë˜‘í•˜ê²Œ", "ì²œì¬ ì²˜ëŸ¼", "í• ë“¯ ë§ë“¯", "ëšœì‰ìŠ¤ëŸ½ê²Œ", "ì°°ì§€ê²Œ", "ë¬´ì„­ê²Œ"];
        if(mode == 2){
          pnouns = ["ì´ì†Œí¬ ì‚¬ì›ë‹˜", "ì „í•˜ì˜ ì‚¬ì›ë‹˜", "ì¥ì£¼í™˜ ì£¼ì„ë‹˜", "ê¹€ì„ì£¼ ì£¼ì„ë‹˜", "ê¹€ë¯¼í˜•", "ì–‘ì„¸í›ˆ","ì„í¬ì£¼ ì£¼ì„ë‹˜","ì„œì˜ì€ ê³¼ì¥ë‹˜","ì•ˆìƒì¤€ ëŒ€ë¦¬ë‹˜", "ë°•ì„±í˜¸ ì†Œì¥ë‹˜", "ê¹€ê´‘ì²œ ì´ì‚¬ë‹˜", "í•œì„¸í›ˆ ì´ì‚¬ë‹˜", "ë°•ì—°ê²½ ì°¨ì¥ë‹˜", "ì´ë¯¸ì£¼"];
          adjectives.push("ì„í¬ì£¼ ë‹µê²Œ");
        }
      } else if(mode == 3){
        var engSent = "";
        for(var l=0; l<7; l++){
          var engWord = getWord();
          while(engSent.includes(engWord)){
            engWord = getWord();
          }
          engSent += engWord + (l==6 ? '' : ' ');
        }
        return engSent;
      } else if(mode==4){
        return getPrgSent();
      }

      var sent = ""

      var pnoun = pnouns[ri(pnouns.length)];
      var noun =  nouns[ri(nouns.length)];
      var adjective = adjectives[ri(adjectives.length)];
      var verb = verbs[ri(verbs.length)];

      sent += pnoun + (checkBatchimEnding(pnoun)? "ì€ " : "ëŠ” ") + noun + (checkBatchimEnding(noun)? "ì„ " : "ë¥¼ ") + adjective + " " + verb;
      sent += ".";

      // if(Math.random() < 0.01){
      //   sent = "ì„í¬ì£¼ëŠ” ìƒë‹¹íˆ í­ë ¥ì ì´ë‹¤. ì¡°ì‹¬í•´ë¼. í•­ìƒ.";
      // }
      
      // if(Math.random() < 0.01){
      //   sent = "ê°‘ìê¸° ì˜íƒ€ ì‹œí—˜ ê³ ê³  abcdefghijklmnopqrstuvwxyz";
      // }

      return sent;
    }
    
    function updateScore(){
        var splitProb = $('#testSentInput').text().split(' ');
        var splitAns = $('#chatInput').val().split(' ');
        
        //var length = splitProb.length > splitAns.length ? splitAns.length : splitProb.length;
        
        for(var i=0; i<splitProb.length; i++){
            var eq = false;
            for(var j=0; j<splitAns.length; j++){
                if(splitProb[i] == splitAns[j]){
                    eq = true;
                    correctWordCount+=1;
                    break;
                }
            }
            if(!eq){
                var atmp = i >= splitAns.length ? '?' : splitAns[i];
                attmpWordArr.push(atmp);
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }

        var sentenceEndDate = new Date();
        var setenceSecondsElapsed = Math.round((sentenceEndDate - startSentenceTime)/1000);

        $('#comment').text(getComment());
        $('#comment').css("visibility", "visible");
        $('#comment').addClass('comment-fade-in')
        $('#comment').on("animationend", function(){
          $(this).css("visibility", "hidden");
          $(this).removeClass('comment-fade-in');
        });

        
        
        /*
        for(var i=0; i< length; i++){
            if(splitProb[i] == splitAns[i]){
                correctWordCount+=1;
            } else {
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }
        */
    }

    function getComment(){
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }

      var tmpAccuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      var tmpScore = Math.round(keyPressCount * timeLimit/secondsPassed * tmpAccuracy);
      if(mode==3||mode==4){
        tmpScore = Math.round(tmpScore/5);
      }
        
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(tmpScore < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }

    function getGrade(){
      //accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      //score = Math.round(keyPressCount * timeLimit/secondsPassed * accuracy);
        
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(score < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }
    
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    // document.addEventListener('input', event => {
    //   console.log("new event: " + event.target.value);
    // });

    document.addEventListener('keydown', event => {
      if(started){
        keyPressCountTmp+=1;
        //const key = event.key.toLowerCase();
        const keyCode = event.code;
        //console.log(keyCode);
        //console.log(key);
        //console.log(event);

        if(keyCode != "Backspace"){
          cheatDetect.push(keyCode);
        
          //cheat detection
          if(cheatDetect.length >= 10){
            cheatDetect.shift();

            var cheating = true;
            for(var z = 1; z < cheatDetect.length; z++){
              if(cheatDetect[z-1] != cheatDetect[z]){
                cheating = false;
                break;
              }
            }
            if(cheating){
              alert("[ì ìˆ˜ ì¡°ì‘ ë°©ì§€ ì•Œë¦¼]");
            }
          }
        }

        if(keyMap.has(keyCode)){
          keyMap.set(keyCode, keyMap.get(keyCode) + 1);
        } else {
          keyMap.set(keyCode, 1);
        }
        
        if(keyCode=="Enter"){
          keyPressCount += keyPressCountTmp;
          keyPressCountTmp = 0;
          updateScore();
          updateSentenceTriplet();
          givenSentenceList.push(sentenceTriplet[2]);
          typedSentenceList.push($('#chatInput').val());

          // Simple content update without dramatic animations
          $('#testSentInputBefore').html(sentenceTriplet[0]);
          $('#testSentInput').html(sentenceTriplet[1]);
          $('#testSentInputAfter').html(sentenceTriplet[2]);
          
          // Mark the previous input in the after section
          $("#testSentInputAfter").unmark();
          $('#testSentInputAfter').mark(prevInputSent);
          
          prevInputSent = $('#chatInput').val();
          $('#chatInput').val("");
        }


        
        $("#testSentInput").unmark();
        var totalInput = $('#chatInput').val();
        $('#testSentInput').mark(totalInput);
      }
    });
});
    </script>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
  <script src="js/transit.js"></script>  
  <script src="js/sent_generator.js"></script> 
  <script src="js/sent_generator_kr.js"></script> 
  <script src="js/prg_sent.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/ko.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js" integrity="sha512-19TrqSGVSwaC2IDGHrD+tAkX59/w5cXy0BHDVwn7OJQXxavORhFSFM7DOO9soXKuo8O7gGNHiG9R2vFrXRBcTQ==" crossorigin="anonymous"></script>
    <script src="data/adjectives.js"></script>
    <script src="data/verbs.js"></script>
    <script src="data/nouns.js"></script>
    <script src="data/simple_words.js"></script>
  </body>
</html>
