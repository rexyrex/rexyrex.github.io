<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex Typing Game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" type="text/css" href="css/typespeed2.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="/js/common.js"></script>
  </head>

  <body>
    <div id="nav-placeholder"></div>
    
    <!-- Animated Background -->
    <div class="animated-bg">
      <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
      </div>
    </div>

    <div class="container">
      <!-- Header Section -->
      <div class="hero-section-typing">
        <div class="hero-content-typing text-center">
          <div class="typing-avatar">
            <div class="avatar-glow"></div>
            <div class="avatar-ring"></div>
            <div class="avatar-inner" id="keyboardIcon">
              <i class="fas fa-keyboard"></i>
            </div>
            <div class="status-indicator"></div>
          </div>
          
          <h1 class="hero-title-typing">
            <span class="title-main">Rexyrex</span>
            <span class="title-accent">.</span>
          </h1>
          
          <div class="hero-subtitle-typing">
            <span class="subtitle-text">타자 속도 측정기</span>
          </div>
          
          <div class="rankings-inline">
            <button id="highScoreBtnDaily" class="ranking-btn-inline" onclick="openHighscoresModal(true)">
              <i class="fas fa-calendar-day"></i>
              <span>오늘 순위</span>
            </button>
            
            <button id="highScoreBtnAll" class="ranking-btn-inline" onclick="openHighscoresModal(false)">
              <i class="fas fa-crown"></i>
              <span>역대 순위</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Landing Button -->
      <button id="startBtn" class="mega-start-btn" onclick="showModeSelection()">
        <div class="mega-btn-bg"></div>
        <div class="mega-btn-content">
          <div class="mega-btn-icon">
            <i class="fas fa-keyboard"></i>
          </div>
          <div class="mega-btn-text">
            <span class="mega-btn-title">게임 시작</span>
            <span class="mega-btn-subtitle">Click to Start Typing</span>
          </div>
        </div>
        <div class="mega-btn-pulse"></div>
        <div class="mega-btn-glow"></div>
      </button>

      <!-- Main Game Section -->
      <div id="grp1" class="game-section" style="display: none;">
        <!-- Mode Selection (initially hidden) -->
        <div class="mode-selection-section" id="modeSelectionSection" style="display: none;">
          <div class="section-header-card">
            <div class="section-badge">
              <i class="fas fa-gamepad"></i>
              <span>게임 모드 선택</span>
            </div>
          </div>
          
          <div class="mode-grid" id="modeGrp">
            <button id="chMod1" type="button" class="mode-card" onclick="selectModeAndStart(1)">
              <div class="mode-icon">
                <i class="fas fa-language"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">한타</div>
                <div class="mode-description">한글 타자</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod2" type="button" class="mode-card" onclick="selectModeAndStart(2)">
              <div class="mode-icon">
                <i class="fas fa-building"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">이포넷</div>
                <div class="mode-description">회사 모드</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod3" type="button" class="mode-card" onclick="selectModeAndStart(3)">
              <div class="mode-icon">
                <i class="fas fa-globe-americas"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">영타</div>
                <div class="mode-description">English</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod4" type="button" class="mode-card" onclick="selectModeAndStart(4)">
              <div class="mode-icon">
                <i class="fas fa-code"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">개발자</div>
                <div class="mode-description">Programming</div>
              </div>
              <div class="mode-glow"></div>
            </button>
          </div>
        </div>

      </div>

      <!-- Countdown Section -->
      <div id="countdownSection" class="countdown-section" style="display: none;">
        <div class="countdown-content">
          <div class="countdown-icon">
            <i class="fas fa-stopwatch"></i>
          </div>
          <div class="countdown-text">
            <h2 class="countdown-title">준비하세요!</h2>
            <p class="countdown-subtitle">게임이 곧 시작됩니다</p>
          </div>
          <div class="countdown-timer">
            <span id="countdownNumber">5</span>
          </div>
          <div class="countdown-progress">
            <div id="countdownBar" class="countdown-bar"></div>
          </div>
        </div>
      </div>

      <!-- Game Area (only appears when game starts) -->
      <div id="grp2" class="game-area-main" style="display: none;">
        <!-- Progress Bar -->
        <div class="progress-section">
          <div id="prgBar" class="progress-modern">
            <div class="progress-bar-modern progress-bar-striped progress-bar-animated" 
                 role="progressbar" aria-valuenow="100" aria-valuemin="0" 
                 aria-valuemax="100">60</div>
          </div>
        </div>
        
        <!-- Text Display Areas -->
        <div class="text-display-modern">
          <div class="text-section">
            <span id="testSentInputBefore" class="text-previous unselectable" style="pointer-events:none;"></span>
          </div>
          
          <div class="text-section">
            <span id="testSentInput" class="text-current unselectable" style="pointer-events:none;"></span>
          </div>
          
          <div class="text-section">
            <span id="testSentInputAfter" class="text-next unselectable" style="pointer-events:none;"></span>
          </div>
          
          <!-- Input Field -->
          <div class="input-section">
            <input id="chatInput" class="input-modern" autocomplete="off" placeholder="여기에 입력하세요..."/>
          </div>

          <!-- Comment Display -->
          <div class="comment-section text-center">
            <p id="comment" class="comment-modern" style="visibility:hidden;">ddd</p>
          </div>
        </div>
      </div>



      <!-- Result Modal -->
      <div id="testModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="resultModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resultModalTitle">
                <i class="fas fa-trophy"></i> 결과
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="result-stats">
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-medal"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">등급</div>
                    <div id="resGrade" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-tachometer-alt"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">점수</div>
                    <div id="resScore" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">상대 평가</div>
                    <div id="resComp" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-bullseye"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">정확도</div>
                    <div id="resAccuracy" class="stat-value">-</div>
                  </div>
                </div>
              </div>

              <div class="text-center mb-3">
                <button id="openSaveCollapseBtn" onclick="openSaveCollapseBtn()" class="hero-btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  <span class="btn-text">
                    <i class="fas fa-save"></i>
                    기록 저장
                  </span>
                  <div class="btn-shine"></div>
                </button>
              </div>

              <div class="collapse" id="collapseExample">
                <div class="modal-card">
                  <!-- Save Form (shown initially) -->
                  <div id="saveForm">
                    <div class="form-group">
                      <label for="highscoreId" class="form-label">이름</label>
                      <input id="highscoreId" class="form-control" autocomplete="off" placeholder="닉네임을 입력하세요" />
                      <div id="saveErrorMessage" class="invalid-feedback" style="display: none;"></div>
                    </div>
                    <button class="hero-btn btn-primary w-100" type="button" onclick="saveHighscore();">
                      <span class="btn-text">
                        <i class="fas fa-check"></i>
                        기록 저장
                      </span>
                      <div class="btn-shine"></div>
                    </button>
                  </div>
                  
                  <!-- Success Message (shown after successful save) -->
                  <div id="saveSuccess" style="display: none;">
                    <div class="text-center">
                      <div class="save-success-icon">
                        <i class="fas fa-check-circle"></i>
                      </div>
                      <h4 class="save-success-title">기록이 저장되었습니다!</h4>
                      <p id="saveSuccessMessage" class="save-success-text"></p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-center mb-3">
                <button id="toggleIncorrectWords" class="modern-btn btn-secondary" type="button" onclick="toggleIncorrectWordsList()">
                  <i id="toggleIcon" class="fas fa-chevron-down"></i> 틀린 단어 목록
                </button>
              </div>

              <div class="collapse" id="collapseExample2">
                <div class="error-list-card">
                  <ul id="incList" class="error-list"></ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> 닫기
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Highscore Modal -->
      <div id="highscoreModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="highscoreModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="highscoreModalTitle">
                <i class="fas fa-trophy"></i> 타자 속도 순위
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            
            <div class="modal-body">
              <nav class="nav nav-pills nav-justified mb-3">
                <a id="korScoreTab" class="nav-item nav-link active" href="#">
                  <i class="fas fa-language"></i> 한타
                </a>
                <a id="engScoreTab" class="nav-item nav-link" href="#">
                  <i class="fas fa-globe-americas"></i> 영타
                </a>
                <a id="prgScoreTab" class="nav-item nav-link" href="#">
                  <i class="fas fa-code"></i> 개발자
                </a>
              </nav>

              <div class="score-title-card">
                <h4 id="scoreTitle" class="score-title">한타 순위</h4>
                <p class="score-subtitle">(100위 까지 보여줍니다.)</p>
              </div>

              <div class="tableFixHead">
                <table id="highScoreTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col"><i class="fas fa-medal"></i> 순위</th>
                      <th scope="col"><i class="fas fa-user"></i> 이름</th>
                      <th scope="col"><i class="fas fa-star"></i> 등급</th>
                      <th scope="col"><i class="fas fa-tachometer-alt"></i> 점수</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div id="highLoading" class="loading-indicator" style="visibility:hidden;">
                  <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> 닫기
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Version Modal -->
      <div id="versionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="versionModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="versionModalTitle">
                <i class="fas fa-code-branch"></i> Version History
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="tableFixHead">
                <table id="versionTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col"><i class="fas fa-tag"></i> 버전</th>
                      <th scope="col"><i class="fas fa-list"></i> 변경 사항</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> 닫기
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Removed old jQuery 1.11.1 to fix conflicts -->

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyANe3HNZoH-3vYVA4tyZRLA_qmsPYmfvbE",
        authDomain: "rextypingspeed.firebaseapp.com",
        projectId: "rextypingspeed",
        storageBucket: "rextypingspeed.appspot.com",
        messagingSenderId: "329903137752",
        appId: "1:329903137752:web:749c515f41a710b265c8ad",
        measurementId: "G-77L95J37F1"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>


    <script>

    var db;
    
    var progress;
    var secondsPassed;
    var timeLimit;
    var started;
    var keyPressCount;
    var keyPressCountTmp;
    
    var correctWordCount;
    var incorrectWordCount;
    
    var incWordArr;
    var attmpWordArr;

    var timerStartedOnce;

    var startSentenceTime;

    var score;
    var accuracy;

    var scoreSaved;

    var sentenceTriplet;
    var prevInputSent;

    var countingDown;

    var mode;

    var daily = false;

    const cheatDetect = [];

    var givenSentenceList;
    var typedSentenceList;

    const keyMap= new Map();

    const version = 8;

    var uuid = uuidv4();
    
    var level = [
      {"s" : 200, "l" : '죄송한데... 손가락 2개세요?'}, 
      {"s" : 300, "l" : '분발하셔야겠어요'}, 
      {"s" : 380, "l" : '이정도면 평타'}, 
      {"s" : 420, "l" : '평균 이상'}, 
      {"s" : 470, "l" : '빠른편'}, 
      {"s" : 520, "l" : '개발자'}, 
      {"s" : 560, "l" : 'pc카톡 많이 한거 티나네 (임희주급)'}, 
      {"s" : 600, "l" : '타자 말고 잘하는게 없을 확률 높음'}, 
      {"s" : 650, "l" : '대회 나가도 될듯'}, 
      {"s" : 700, "l" : '타자 신'}, 
      {"s" : 740, "l" : '해킹 유저'},
      {"s" : 780, "l" : '기계'},
      {"s" : 820, "l" : '초월자'},
      {"s" : 999999, "l" : '띠용'}
    ];

    var englevel = [
      {"s" : 20, "l" : 'Slowpoke'}, 
      {"s" : 30, "l" : 'Practice makes perfect'}, 
      {"s" : 40, "l" : 'Not bad'}, 
      {"s" : 50, "l" : 'Above Average'}, 
      {"s" : 60, "l" : 'Quite fast'}, 
      {"s" : 70, "l" : 'Developer'}, 
      {"s" : 80, "l" : 'Bunny Typer'}, 
      {"s" : 90, "l" : 'Professional Typer'}, 
      {"s" : 100, "l" : 'Typing God'}, 
      {"s" : 110, "l" : 'Hacker'},
      {"s" : 120, "l" : 'Machine'},
      {"s" : 130, "l" : 'Ridonculous'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    var prglevel = [
      {"s" : 20, "l" : '백수'}, 
      {"s" : 27, "l" : '신입'}, 
      {"s" : 32, "l" : '주임'}, 
      {"s" : 38, "l" : '대리'}, 
      {"s" : 45, "l" : '과장'}, 
      {"s" : 52, "l" : '차장'}, 
      {"s" : 59, "l" : '부장'}, 
      {"s" : 65, "l" : '이사'}, 
      {"s" : 70, "l" : '사장'}, 
      {"s" : 75, "l" : '회장'}, 
      {"s" : 80, "l" : '대통령'},
      {"s" : 85, "l" : 'Elon Musk'},
      {"s" : 90, "l" : '뇌로 프로그래밍하는 외계인'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    const scoreTabs = ['korScoreTab','engScoreTab', 'prgScoreTab'];
    
    $(function () {

      $('#korScoreTab').on('click', function (e) {
        setScoreTab('kor');
      })

      $('#engScoreTab').on('click', function (e) {
        setScoreTab('eng');
      })

      $('#prgScoreTab').on('click', function (e) {
        setScoreTab('prg');
      })

      $('#verTitle').text("Ver " + version);
      changeMode(1);
      db = firebase.firestore();
      saveLogin();
      checkVersion();
      timerStartedOnce = false;
      reset();

      //var textgen = new TextGen();
      //alert(textgen.sentence());
    });

    function setScoreTab(tabType){
      if(tabType=='kor'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("한타 순위" + (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (역대)'));
        $('#korScoreTab').addClass('active');
        loadHighscoreData('kor');
      } else if(tabType=='eng'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("English Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (역대)'));
        $('#engScoreTab').addClass('active');
        loadHighscoreData('eng');
      } else if(tabType=='prg'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("Programmer Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (역대)'));
        $('#prgScoreTab').addClass('active');
        loadHighscoreData('prg');
      }
    }

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function saveLogin(){
      db.collection("login").add({
            uuid: uuid,
            navigator: navigator.userAgent,
            date: moment().format('MM-DD-YYYY HH:mm:ss')
          }).then((docRef) => {
            
          })
          .catch((error) => {

          });
    }

    function checkVersion(){
      db.collection("version").orderBy("ver", "desc").limit(1)
      .get()
      .then((querySnapshot) => {
          var serverVer = 100000;
          querySnapshot.forEach((doc) => {
              serverVer = parseInt(doc.data().ver);
          });

          if(version < serverVer){
            alert("캐시를 지워주세요. (Client ver: " + version + ", Server ver: " + serverVer + ")");
            //window.location.reload(true);
            $('#startBtn').text("캐시를 지워주세요.");
            $('#startBtn').attr('disabled', true);

            fadeOut("grp2");
            fadeOut("highScoreBtnDaily");
            fadeOut("highScoreBtnAll")
            fadeOut("modeGrp");
          }

      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }

    function openVersionModal(){
      $('#versionModal').modal('show');

      db.collection("version").orderBy("ver", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var versionList = [];
          querySnapshot.forEach((doc) => {
              //console.log(doc.id, " => ", doc.data());
              versionList.push(doc.data());
          });

          $('#versionTable tbody').empty();
          for(var i=0; i<versionList.length; i++){
            $('#versionTable tbody').append("<tr><td>" + versionList[i].ver + "</td><td>"+ versionList[i].desc + "</td>");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });

    }

    function changeMode(m){
      console.log('changeMode called with mode:', m);
      console.log('Stack trace:', new Error().stack);
      
      // if(m==4){
      //   alert("준비중입니다");
      //   return;
      // }
      mode = m;
      
      // Remove active class from all mode buttons
      $('.mode-card').removeClass('active');
      
      // Add active class to selected mode button
      $('#chMod'+m).addClass('active');
    }

    function openSaveCollapseBtn(){
      $('#openSaveCollapseBtn').css("visibility", "hidden");
      // Reset save form state when opening
      resetSaveForm();
    }

    function resetSaveForm(){
      clearSaveError();
      $('#saveForm').show();
      $('#saveSuccess').hide();
      $('#highscoreId').val('');
    }

    function toggleIncorrectWordsList(){
      var $collapse = $('#collapseExample2');
      var $icon = $('#toggleIcon');
      
      if($collapse.hasClass('show')){
        // Currently open, so close it
        $collapse.removeClass('show');
        $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
      } else {
        // Currently closed, so open it
        $collapse.addClass('show');
        $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
      }
    }

    function showSaveError(message) {
      $('#highscoreId').addClass('is-invalid');
      $('#saveErrorMessage').text(message).show();
    }

    function clearSaveError() {
      $('#highscoreId').removeClass('is-invalid');
      $('#saveErrorMessage').hide();
    }

    function showSaveSuccess(message) {
      $('#saveForm').hide();
      $('#saveSuccessMessage').text(message);
      $('#saveSuccess').show();
    }

    function updateSentenceTriplet(){
      if(sentenceTriplet.length == 0){
        sentenceTriplet.push(generateSentence());
        sentenceTriplet.push(generateSentence());
        sentenceTriplet[2] = '.';
      } else {
        //triplet is of length 2 or 3
        sentenceTriplet[2] = sentenceTriplet[1];
        sentenceTriplet[1] = sentenceTriplet[0];
        sentenceTriplet[0] = generateSentence();
      }
    }

    function saveHighscore(){
      clearSaveError(); // Clear any previous error messages
      
      var username = $('#highscoreId').val().trim();
      
      if(username.length < 2){
        showSaveError("이름이 너무 짧아요. (최소 2글자)");
        return;
      } else if(username.length > 8){
        showSaveError("이름이 너무 길어요. (최대 8글자)");
        return;
      }

      if(score<0 || isNaN(score)){
        showSaveError("기록 저장 불가 - 한 단어도 안치셨네요 :(");
        return;
      }

      if(!scoreSaved){
        scoreSaved = true;
        addHighscore(username, score, getGrade(), Math.round(accuracy*100)+'%');   
        updateAnonHighscore();     
      } else {
        showSaveError("이미 기록 저장하셨네요~");
      }
    }

    function addAnonHighscore(score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      db.collection(collectionName).add({
            uuid: uuid,
            id: "",
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            
          })
          .catch((error) => {
            console.log("error:");
            console.log(error);
          });
    }

    function updateAnonHighscore(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      var tmpId = $('#highscoreId').val();
      db.collection(collectionName).where("uuid", "==", uuid).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          db.collection(collectionName).doc(doc.id).update({
              id: tmpId,
          })
          .then(() => {
            
          })
        })
      })
    }

    function addHighscore(username, score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var userExists = false;
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      //Check if username exists
      db.collection(collectionName).where("id", "==", username).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            userExists = true;
            //console.log(doc.id, " => ", doc.data());
            //username exists and new highscore reached
            if(doc.data().score < score){
              db.collection(collectionName).doc(doc.id).update({
                  score: score,
                  accuracy: accuracy,
                  correctWordCount : correctWordCount,
                  incorrectWordCount : incorrectWordCount,
                  givenSentenceList : givenSentenceList,
                  typedSentenceList : typedSentenceList,
                  keyMap : keyArr,
                  rank: rank,
                  clientVersion: version,
                  mode: mode,
                  cheatDetect: cheatDetect,
                  keyPressCount: keyPressCount,
                  keyPressCountTmp: keyPressCountTmp,
                  date: moment().format('MM-DD-YYYY HH:mm'),
                  day: moment().format('MM-DD-YYYY')
              })
              .then(() => {
                showSaveSuccess("기록을 갱신하셨습니다! (" + doc.data().score + " → " + score + "점)");
              })
            } else {
              showSaveError("더 높은 기록이 있습니다. (현재 최고 기록: " + doc.data().score + "점)");
            }
        });
        //Add new user
        if(!userExists){
          db.collection(collectionName).add({
            id: username,
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            showSaveSuccess("새로운 기록이 저장되었습니다! (" + score + "점)");
          })
          .catch((error) => {
            showSaveError("저장 중 오류가 발생했습니다. 다시 시도해주세요.");
          });
        }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }

    function openHighscoresModal(dly){

      daily = dly;

      $('#highLoading').css("visibility", "visible");
      
      setScoreTab('kor');

      $('#highscoreModal').modal('show');
    }

    function loadHighscoreData(scoreType){
      var collectionName = '';
      if(!daily){
        if(scoreType=='kor'){
          collectionName = "records2";
        } else if(scoreType == 'eng'){
          collectionName = "engRecords";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecords";
        }
      } else {
        //daily
        if(scoreType=='kor'){
          collectionName = "recordsAnon";
        } else if(scoreType == 'eng'){
          collectionName = "engRecordsAnon";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecordsAnon";
        }
      }

      if(!daily){
        db.collection(collectionName).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#highScoreTable tbody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + highList[i].id + "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      } else {
        //daily
        db.collection(collectionName).where("day", "==", moment().format('MM-DD-YYYY')).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#highScoreTable tbody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + (highList[i].id == '' ?  '익명 유저' : highList[i].id)+ "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      }
      
    }

    function checkRank(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      db.collection(collectionName).orderBy("score", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var highList = [];
         var i = 0;
         var place = 101;
         var tmpSaved = false;
          querySnapshot.forEach((doc) => {
              highList.push(doc.data());
              i+=1;
              if(score>doc.data().score && !tmpSaved){
                tmpSaved = true;
                place = i;
              }
          });

          if(place < 101){
            $('#resComp').text("상위" + Math.round(place/i*100) + "% (" + i + "명 중 " + place + "등)" );
          } else if(i < 101){
            $('#resComp').text(i + "명 중 꼴등");
          } else {
            $('#resComp').text("100등 안에 못들었어요");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }
    
    function reset(){
      console.log('Reset called - before reset: secondsPassed:', secondsPassed, 'started:', started);
      
      // Clear any active countdown timer
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      uuid = uuidv4();

      started = false;
      countingDown = false;
      progress = 0;
      secondsPassed = 0;
      keyPressCount = 0;
      keyPressCountTmp = 0;
      timeLimit = 60;
      scoreSaved = false;
      
      // Reset smooth animation timer
      window.gameStartTime = null;
      
      correctWordCount = 0;
      incorrectWordCount = 0;
      score = 0;
      accuracy = 0;
      incWordArr = [];
      attmpWordArr = [];

      sentenceTriplet = [];
      prevInputSent = "";

      typedSentenceList = [];
      givenSentenceList = [];

      keyMap.clear();
      
      console.log('Reset completed - after reset: secondsPassed:', secondsPassed, 'started:', started);
      
      // Clear content, animations, and data attributes
      $('#testSentInput').html('').removeData('original-text');
      $('#testSentInputBefore').html('').removeData('original-text');
      $('#testSentInputAfter').html('').removeData('original-text');
      $('#chatInput').val('');
      
      // Reset progress bar
      $(".progress-bar-modern").css("width", "100%").text("60").css('background', 'var(--success)');
      
      // Reset save form state
      resetSaveForm();
      
      // Reset all animation classes and structure
      $('.hero-section-typing').show().removeClass('menu-fade-out');
      $('#startBtn').show().removeClass('menu-fade-out');
      $('#modeSelectionSection').hide();
      $('#grp1').hide(); // Hide game section container
      $('#grp2').removeClass('game-start-transition').hide();
      $('#countdownSection').hide().removeClass('text-reveal menu-fade-out'); // Hide countdown section
      $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
      $('#testSentInput').removeClass('text-reveal');
      $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
      $('#chatInput').removeClass('input-focus-ready');
      $('#startBtn').removeClass('countdown-pulse').html('<div class="mega-btn-bg"></div><div class="mega-btn-content"><div class="mega-btn-icon"><i class="fas fa-keyboard"></i></div><div class="mega-btn-text"><span class="mega-btn-title">게임 시작</span><span class="mega-btn-subtitle">Click to Start Typing</span></div></div><div class="mega-btn-pulse"></div><div class="mega-btn-glow"></div>');
      $('#startBtn').attr('onclick', 'showModeSelection()');
      
      // Clear any comment visibility
      $('#comment').css("visibility", "hidden");
      
      // Reset countdown display
      if (document.getElementById('countdownNumber')) {
        document.getElementById('countdownNumber').textContent = '5';
      }
      if (document.getElementById('countdownBar')) {
        document.getElementById('countdownBar').style.width = '100%';
      }
    }

    function retry(){
      reset();
      // Don't call start() directly, let startCountDown() handle the flow
    }

    function fadeIn(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      //animate(elemId, "animateFadeIn", function(){$('#' + elemId).css("visibility", "visible").css("opacity", 1);});
      $('#' + elemId).transition({opacity:1},4000, "snap"); 
    }

    function fadeIn2(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      $('#' + elemId).transition({opacity:0.27},4000, "snap");
    }

    function fadeOut(elemId){
      $('#' + elemId).css("opacity", 1);
      $('#' + elemId).transition({opacity:0}, 4000, "snap", function(){$('#' + elemId).css("visibility", "hidden").css("opacity", 0);});
    }

    function animate(elemId, anim, fn){
      //console.log("animating : " + elemId + ", " + anim);
      $('#' + elemId).addClass(anim);
      $('#' + elemId).on("animationend", function(){
        fn();
        $(this).removeClass(anim);
      });
    }

    function showModeSelection() {
      console.log('Showing mode selection...');
      console.log('Current state - started:', started, 'countingDown:', countingDown, 'timerStartedOnce:', timerStartedOnce);
      
      // Ensure we start from a clean state
      $('#grp2').hide();
      $('#countdownSection').hide();
      $('#modeSelectionSection').hide().removeClass('text-reveal menu-fade-out');
      $('#grp1').removeClass('menu-fade-out');
      
      // Show hero section and button if they're not visible
      $('.hero-section-typing').show().removeClass('menu-fade-out');
      $('#startBtn').show().removeClass('menu-fade-out');
      
      // Hide landing elements
      $('.hero-section-typing').addClass('menu-fade-out');
      $('#startBtn').addClass('menu-fade-out');
      
      // Show mode selection after animation
      setTimeout(() => {
        console.log('Mode selection timeout triggered - showing mode selection');
        $('.hero-section-typing').hide();
        $('#startBtn').hide();
        $('#grp1').show(); // Show the game section container
        
        // Force animation reset by removing class, forcing reflow, then adding back
        $('#modeSelectionSection').removeClass('text-reveal').css('opacity', '').css('transform', '').show();
        // Force reflow to ensure style reset takes effect
        $('#modeSelectionSection')[0].offsetHeight;
        $('#modeSelectionSection').addClass('text-reveal');
        console.log('Mode selection should now be visible');
        
        // Debug: Check if mode selection is actually visible
        setTimeout(() => {
          console.log('Checking mode selection visibility after 1 second...');
          console.log('grp1 display:', $('#grp1').css('display'));
          console.log('modeSelectionSection display:', $('#modeSelectionSection').css('display'));
          console.log('modeSelectionSection visible:', $('#modeSelectionSection').is(':visible'));
        }, 1000);
        
        setTimeout(() => {
          console.log('Checking mode selection visibility after 3 seconds...');
          console.log('grp1 display:', $('#grp1').css('display'));
          console.log('modeSelectionSection display:', $('#modeSelectionSection').css('display'));
          console.log('modeSelectionSection visible:', $('#modeSelectionSection').is(':visible'));
        }, 3000);
      }, 500);
    }

    // Long click functionality for keyboard icon
    let longClickTimer = null;
    let isLongClicking = false;

    function setupLongClick() {
      const keyboardIcon = document.getElementById('keyboardIcon');
      
      function startLongClick() {
        isLongClicking = true;
        longClickTimer = setTimeout(() => {
          if (isLongClicking) {
            openVersionModal();
          }
        }, 3000); // 3 seconds
      }

      function cancelLongClick() {
        isLongClicking = false;
        if (longClickTimer) {
          clearTimeout(longClickTimer);
          longClickTimer = null;
        }
      }

      // Mouse events
      keyboardIcon.addEventListener('mousedown', startLongClick);
      keyboardIcon.addEventListener('mouseup', cancelLongClick);
      keyboardIcon.addEventListener('mouseleave', cancelLongClick);

      // Touch events
      keyboardIcon.addEventListener('touchstart', startLongClick);
      keyboardIcon.addEventListener('touchend', cancelLongClick);
      keyboardIcon.addEventListener('touchcancel', cancelLongClick);
    }

    // Initialize long click when page loads
    $(document).ready(function() {
      setupLongClick();
    });

    function selectModeAndStart(modeNumber) {
      console.log('selectModeAndStart called with mode:', modeNumber);
      console.log('Stack trace:', new Error().stack);
      console.log('Current state when mode selected - started:', started, 'countingDown:', countingDown);
      
      // Set the mode
      changeMode(modeNumber);
      
      // Show countdown instead of starting immediately
      setTimeout(() => {
        showCountdown();
      }, 200);
    }

    function showCountdown() {
      console.log('showCountdown() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);
      
      // Hide mode selection
      $('#grp1').addClass('menu-fade-out');
      
      // Show countdown after animation
      setTimeout(() => {
        $('#grp1').hide();
        $('#countdownSection').show().addClass('text-reveal');
        startCountdownTimer();
      }, 500);
    }

    let countdownInterval;
    
    function startCountdownTimer() {
      let timeLeft = 5;
      const countdownNumber = document.getElementById('countdownNumber');
      const countdownBar = document.getElementById('countdownBar');
      
      // Reset bar width
      countdownBar.style.width = '100%';
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        countdownNumber.textContent = timeLeft;
        
        // Update progress bar
        const progressPercent = (timeLeft / 5) * 100;
        countdownBar.style.width = progressPercent + '%';
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          
          // Hide countdown and start game
          $('#countdownSection').addClass('menu-fade-out');
          setTimeout(() => {
            $('#countdownSection').hide().removeClass('text-reveal menu-fade-out');
            // Reset countdown for next time
            countdownNumber.textContent = '5';
            countdownBar.style.width = '100%';
            
            // Start game immediately without additional countdown
            startGameDirectly();
          }, 500);
        }
      }, 1000);
    }

    function retryGame() {
      console.log('Retrying game - going directly to mode selection...');
      console.log('Before reset - started:', started, 'countingDown:', countingDown, 'timerStartedOnce:', timerStartedOnce);
      
      // Clear ALL possible timers and intervals more aggressively
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      // Clear any potential setTimeout calls by getting the highest timeout ID and clearing them
      let highestTimeoutId = setTimeout(";");
      for (let i = 0; i < highestTimeoutId; i++) {
        clearTimeout(i);
      }
      
      // Reset only the game variables, not the UI state
      resetGameVariables();
      
      console.log('After reset - started:', started, 'countingDown:', countingDown, 'timerStartedOnce:', timerStartedOnce);
      
      // Close modal if open
      $('#testModal').modal('hide');
      
      // Go directly to mode selection (like clicking "게임 시작") with a longer delay
      setTimeout(() => {
        console.log('Showing mode selection after retry...');
        showModeSelection();
      }, 800);
    }

    function resetGameVariables() {
      console.log('Resetting game variables only...');
      
      uuid = uuidv4();
      started = false;
      countingDown = false;
      progress = 0;
      secondsPassed = 0;
      keyPressCount = 0;
      keyPressCountTmp = 0;
      timeLimit = 60;
      scoreSaved = false;
      timerStartedOnce = false; // Reset timer state so it can start fresh
      
      // Reset smooth animation timer
      window.gameStartTime = null;
      
      correctWordCount = 0;
      incorrectWordCount = 0;
      score = 0;
      accuracy = 0;
      incWordArr = [];
      attmpWordArr = [];

      sentenceTriplet = [];
      prevInputSent = "";

      typedSentenceList = [];
      givenSentenceList = [];

      keyMap.clear();
      
      // Clear content and data attributes
      $('#testSentInput').html('').removeData('original-text');
      $('#testSentInputBefore').html('').removeData('original-text');
      $('#testSentInputAfter').html('').removeData('original-text');
      $('#chatInput').val('');
      
      // Reset progress bar
      $(".progress-bar-modern").css("width", "100%").text("60").css('background', 'var(--success)');
      
      // Reset save form state
      resetSaveForm();
      
      // Clear any comment visibility
      $('#comment').css("visibility", "hidden");
      
      // Reset countdown display
      if (document.getElementById('countdownNumber')) {
        document.getElementById('countdownNumber').textContent = '5';
      }
      if (document.getElementById('countdownBar')) {
        document.getElementById('countdownBar').style.width = '100%';
      }
      
      // Clear animation classes from game elements
      $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
      $('#testSentInput').removeClass('text-reveal');
      $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
      $('#chatInput').removeClass('input-focus-ready');
      $('#grp2').removeClass('game-start-transition').hide();
      $('#countdownSection').hide().removeClass('text-reveal menu-fade-out');
      
      // Clear active mode selection
      $('.mode-card').removeClass('active');
      mode = null; // Reset mode variable
    }

    function startGameDirectly() {
      console.log('startGameDirectly() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);
      
      if(!started && !countingDown){
        console.log('Starting game directly after countdown...');
        
        // Show game area immediately
        $('#grp2').show().addClass('game-start-transition');
        
        // Prepare game content immediately - ensure fresh start
        console.log('Before updateSentenceTriplet in startGameDirectly - sentenceTriplet:', sentenceTriplet);
        sentenceTriplet = []; // Force clear to ensure fresh sentences
        updateSentenceTriplet();
        console.log('After updateSentenceTriplet in startGameDirectly - sentenceTriplet:', sentenceTriplet);
        
        // Clear any old data attributes and set new content
        $('#testSentInputBefore').removeData('original-text').html(sentenceTriplet[0]).data('original-text', sentenceTriplet[0]);
        $('#testSentInput').removeData('original-text').html(sentenceTriplet[1]).data('original-text', sentenceTriplet[1]);
        $('#testSentInputAfter').removeData('original-text').html(sentenceTriplet[2]).data('original-text', sentenceTriplet[2]);
        
        // Start the game immediately
        start();
      } else {
        console.log('startGameDirectly blocked - started:', started, 'countingDown:', countingDown);
      }
    }

    function startGameCountdown(){
      console.log('startGameCountdown() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);
      
      if(!started && !countingDown){
        console.log('Starting countdown...');
        
        // Hide mode selection and show game area
        $('#modeSelectionSection').addClass('menu-fade-out');
        
        setTimeout(() => {
          $('#modeSelectionSection').hide();
          $('#grp2').show().addClass('game-start-transition');
        }, 300);
        
        countingDown = true;

        var counter = 5;
        
        var counterItv = setInterval(function(){ 
          counter-=1;
          
          if(counter==0){
            clearInterval(counterItv);
            countingDown = false;
            
            // Prepare game content - ensure fresh start
            console.log('Before updateSentenceTriplet in startGameCountdown - sentenceTriplet:', sentenceTriplet);
            sentenceTriplet = []; // Force clear to ensure fresh sentences
            updateSentenceTriplet();
            console.log('After updateSentenceTriplet in startGameCountdown - sentenceTriplet:', sentenceTriplet);
            
            // Clear any old data attributes and set new content
            $('#testSentInputBefore').removeData('original-text').html(sentenceTriplet[0]).data('original-text', sentenceTriplet[0]);
            $('#testSentInput').removeData('original-text').html(sentenceTriplet[1]).data('original-text', sentenceTriplet[1]);
            $('#testSentInputAfter').removeData('original-text').html(sentenceTriplet[2]).data('original-text', sentenceTriplet[2]);
            
            // Start the game
            start();
          }
        }, 1000);
      } else {
        // Debug: log why startCountDown is not executing
        console.log('startCountDown blocked - started:', started, 'countingDown:', countingDown);
      }
    }
    
    function start(){
      if(!started){
        started = true;
        
        // Debug: log timer state when starting
        console.log('Game starting - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
        
        // Add reveal animations to content that's already visible
        setTimeout(() => {
          $('#testSentInputBefore').addClass('text-reveal-delay-1');
          $('#testSentInput').addClass('text-reveal');
          $('#testSentInputAfter').addClass('text-reveal-delay-2');
          $('#chatInput').addClass('input-focus-ready');
        }, 200);
        
        // Focus on input after animations
        setTimeout(() => {
          $('#chatInput').focus();
        }, 1000);
        
        // Set up the game timer (only once)
        if(!timerStartedOnce){
          timerStartedOnce = true;
          
          // Initialize game start time for smooth animation
          window.gameStartTime = Date.now();

          // Main timer that updates every second
          setInterval(function(){ 
              if(started){
                  $('#chatInput').focus();
                  progress = secondsPassed/timeLimit * 100;  
                  var timeLeftVal = 100 - progress;
                  var color = progress < 60 ? 'var(--success)' : (progress < 80 ? 'var(--warning)' : 'var(--error)');
                  $(".progress-bar-modern").css("width", timeLeftVal + "%").text(timeLimit - secondsPassed).css('background', color);
                  
                  // Debug: log timer progress
                  if(secondsPassed % 10 === 0) {
                    console.log('Timer tick - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
                  }
                  
                  secondsPassed+=1;
                  if(secondsPassed > timeLimit){
                    console.log('Timer ended - calling endLogic()');
                    endLogic();
                  }
              }
            }, 1000);
            
          // Smooth progress bar animation - updates every 100ms for smooth effect
          setInterval(function(){
              if(started){
                  // Calculate fractional progress for smooth animation
                  var currentTime = Date.now();
                  var elapsedMs = currentTime - window.gameStartTime;
                  var elapsedSeconds = elapsedMs / 1000;
                  var smoothProgress = elapsedSeconds / timeLimit * 100;
                  var smoothTimeLeftVal = 100 - smoothProgress;
                  
                  // Only update width for smooth animation, keep text from main timer
                  $(".progress-bar-modern").css("width", Math.max(0, smoothTimeLeftVal) + "%");
              }
          }, 100);
          }
        }
    }
    
    function endLogic(){
        if(started){
            started = false;

            // Hide game area
            $('#grp2').removeClass('game-start-transition').hide();
            
            // Clear all animation classes
            $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
            $('#testSentInput').removeClass('text-reveal');
            $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
            $('#chatInput').removeClass('input-focus-ready');
            
            // Clear content
            $('#testSentInput').html('');
            $('#testSentInputBefore').html('');
            $('#testSentInputAfter').html('');
            $('#chatInput').val('');

            // Show landing page again for retry
            setTimeout(() => {
                // Clear any countdown timer and hide all sections
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                $('#grp1').hide(); // Hide the game section container
                $('#countdownSection').hide().removeClass('text-reveal menu-fade-out'); // Hide countdown section
                
                $('.hero-section-typing').show().removeClass('menu-fade-out');
                $('#startBtn').show().removeClass('menu-fade-out').removeClass('countdown-pulse').html('<div class="mega-btn-bg"></div><div class="mega-btn-content"><div class="mega-btn-icon"><i class="fas fa-redo"></i></div><div class="mega-btn-text"><span class="mega-btn-title">재도전</span><span class="mega-btn-subtitle">Try Again</span></div></div><div class="mega-btn-pulse"></div><div class="mega-btn-glow"></div>');
                $('#startBtn').attr('onclick', 'retryGame()');
                
                // Reset countdown display
                document.getElementById('countdownNumber').textContent = '5';
                document.getElementById('countdownBar').style.width = '100%';
            }, 500);

            accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
            score = Math.round((keyPressCount + getEffectiveKeyPressCountTmp()) * accuracy);
            if(mode==3||mode==4){
              score = Math.round(score/5);
            }

            checkRank();

            $('#resScore').text(score);
            $('#resGrade').text("[" + getGrade() + "]");
            $('#resAccuracy').text(Math.round(accuracy * 100) + "% (" + correctWordCount + "/" + (correctWordCount + incorrectWordCount) + ")");

            $('#incList').empty();
            for(var i=0; i<incWordArr.length; i++){
                //console.log((i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')");
                $('#incList').append('<li>' + (i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')" + '</li>')
            }

            if(!isNaN(score)){
              addAnonHighscore(score, getGrade(), accuracy);
            }            

            $('#testModal').modal('show');
        }
    }

    function getEffectiveKeyPressCountTmp(){
      if(typedSentenceList.length == 0){
        return 0;
      } else {
        var avg = Math.round(keyPressCount / typedSentenceList.length);
        if(keyPressCountTmp > avg) {
          return avg;
        } else {
          return keyPressCountTmp;
        }
      }
    }

    function checkBatchimEnding(word) {
      if (typeof word !== 'string') return null;
    
      var lastLetter = word[word.length - 1];
      var uni = lastLetter.charCodeAt(0);
    
      if (uni < 44032 || uni > 55203) return null;
    
      return (uni - 44032) % 28 != 0;
    }

    function encounterMessage(name){
      var adj = checkBatchimEnding(name)?'이':'가';
    }

    function generateName(){
      const f = ["김", "박", "이", "장", "임", "양", "한", "서", "안"];
      const s = ["형", "민", "희", "주", "성", "호", "광", "천", "세", "훈", "석", "영", "은", "연", "경", "고", "운", "소", "희", "정"];

      return f[ri(f.length)] + s[ri(s.length)] + s[ri(s.length)];
    }
    
    function generateSentence(){
      startSentenceTime = new Date();

      var pnouns;
      var nouns;
      var verbs;
      var adjectives;

      if(mode == 1 || mode == 2){
        pnouns = [];
        pnouns.push(generateName());
      
        nouns = ["감자","과자","사탕","낙타","컴퓨터","키보드","다람쥐","공룡","슬랙","핸드폰", "사진기","물컵", "모니터", "창고", "강아지", "고양이", "냉장고", "다리미", "컵", "포크", "숟가락", "명함", "곰", "거북이", "토끼", "빗자루", "쇳덩어리", "구슬", "스트레칭 도구", "마사지 의자", "블루투스 이어폰", "유선 핸드폰", "명품 가방", "하이힐", "뚜레쥬르", "글루", "체리", "서버", "경지실", "경전실", "체리 개발팀", "야구 빠따", "원숭이", "생쥐", "친구", "사람", "모닥불", "아이스크림", "스테이크", "미국산 고기", "살아있는 한우", "소", "강아지", "고양이"]
        
        verbs = ["먹었다", "때렸다","째려봤다","걷어 찼다", "싫어한다", "좋아한다", "혐오한다", "공격했다", "돌려버렸다", "시도했다", "박살냈다", "싸대기 때렸다", "반토막냈다", "쳐다봤다", "패버렸다", "상상해봤다", "갈궜다", "뿌리쳤다", "깨물어버렸다", "개발했다", "해킹했다", "망하게 해버렸다", "망가트렸다", "위조했다", "기부했다", "밀어 냈다", "잡아 당겼다", "욕했다"]

        adjectives = ["맛있게", "힘차게", "겨우", "천천히", "멋있게", "예쁘게", "빠르게", "뜨겁게", "이상하게", "귀엽게", "따끈하게","얄밉게", "차갑게", "어중간하게", "어색하게", "똑똑하게", "천재 처럼", "할듯 말듯", "뚜잉스럽게", "찰지게", "무섭게"];
        if(mode == 2){
          pnouns = ["이소희 사원님", "전하영 사원님", "장주환 주임님", "김석주 주임님", "김민형", "양세훈","임희주 주임님","서영은 과장님","안상준 대리님", "박성호 소장님", "김광천 이사님", "한세훈 이사님", "박연경 차장님", "이미주"];
          adjectives.push("임희주 답게");
        }
      } else if(mode == 3){
        var engSent = "";
        for(var l=0; l<7; l++){
          var engWord = getWord();
          while(engSent.includes(engWord)){
            engWord = getWord();
          }
          engSent += engWord + (l==6 ? '' : ' ');
        }
        return engSent;
      } else if(mode==4){
        return getPrgSent();
      }

      var sent = ""

      var pnoun = pnouns[ri(pnouns.length)];
      var noun =  nouns[ri(nouns.length)];
      var adjective = adjectives[ri(adjectives.length)];
      var verb = verbs[ri(verbs.length)];

      sent += pnoun + (checkBatchimEnding(pnoun)? "은 " : "는 ") + noun + (checkBatchimEnding(noun)? "을 " : "를 ") + adjective + " " + verb;
      sent += ".";

      // if(Math.random() < 0.01){
      //   sent = "임희주는 상당히 폭력적이다. 조심해라. 항상.";
      // }
      
      // if(Math.random() < 0.01){
      //   sent = "갑자기 영타 시험 고고 abcdefghijklmnopqrstuvwxyz";
      // }

      return sent;
    }
    
    function updateScore(){
        var splitProb = $('#testSentInput').text().split(' ');
        var splitAns = $('#chatInput').val().split(' ');
        
        //var length = splitProb.length > splitAns.length ? splitAns.length : splitProb.length;
        
        for(var i=0; i<splitProb.length; i++){
            var eq = false;
            for(var j=0; j<splitAns.length; j++){
                if(splitProb[i] == splitAns[j]){
                    eq = true;
                    correctWordCount+=1;
                    break;
                }
            }
            if(!eq){
                var atmp = i >= splitAns.length ? '?' : splitAns[i];
                attmpWordArr.push(atmp);
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }

        var sentenceEndDate = new Date();
        var setenceSecondsElapsed = Math.round((sentenceEndDate - startSentenceTime)/1000);

        $('#comment').text(getComment());
        $('#comment').css("visibility", "visible");
        $('#comment').addClass('comment-fade-in')
        $('#comment').on("animationend", function(){
          $(this).css("visibility", "hidden");
          $(this).removeClass('comment-fade-in');
        });

        
        
        /*
        for(var i=0; i< length; i++){
            if(splitProb[i] == splitAns[i]){
                correctWordCount+=1;
            } else {
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }
        */
    }

    function getComment(){
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }

      var tmpAccuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      var tmpScore = Math.round(keyPressCount * timeLimit/secondsPassed * tmpAccuracy);
      if(mode==3||mode==4){
        tmpScore = Math.round(tmpScore/5);
      }
        
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(tmpScore < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }

    function getGrade(){
      //accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      //score = Math.round(keyPressCount * timeLimit/secondsPassed * accuracy);
        
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(score < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }
    
    // Enhanced word-aware text highlighting functions
    function highlightText(element, searchText) {
      if (!searchText) {
        return;
      }
      
      var $el = $(element);
      var originalText = $el.data('original-text') || $el.text();
      
      // Store original text if not already stored
      if (!$el.data('original-text')) {
        $el.data('original-text', originalText);
      }
      
      // Split both texts into words, preserving spaces
      var targetWords = originalText.split(' ');
      var typedWords = searchText.split(' ');
      
      var highlightedText = '';
      
      for (var i = 0; i < targetWords.length; i++) {
        var targetWord = targetWords[i];
        var typedWord = typedWords[i] || '';
        
        if (i < typedWords.length - 1) {
          // Complete word (user has moved past this word by typing a space)
          if (typedWord === targetWord) {
            // Correct complete word
            highlightedText += '<mark class="word-correct">' + targetWord + '</mark>';
          } else {
            // Incorrect complete word
            highlightedText += '<mark class="word-incorrect">' + targetWord + '</mark>';
          }
        } else if (i === typedWords.length - 1 && typedWord.length > 0) {
          // Current word being typed
          if (typedWord === targetWord) {
            // Word is complete and correct - mark it green immediately!
            highlightedText += '<mark class="word-correct">' + targetWord + '</mark>';
          } else if (targetWord.startsWith(typedWord)) {
            // Partial match - highlight the typed part
            var typedPart = targetWord.substring(0, typedWord.length);
            var remainingPart = targetWord.substring(typedWord.length);
            highlightedText += '<mark class="word-partial">' + typedPart + '</mark>' + remainingPart;
          } else {
            // Wrong typing in current word
            var matchLength = 0;
            // Find how much of the beginning matches
            for (var j = 0; j < Math.min(typedWord.length, targetWord.length); j++) {
              if (typedWord[j] === targetWord[j]) {
                matchLength++;
              } else {
                break;
              }
            }
            
            if (matchLength > 0) {
              var correctPart = targetWord.substring(0, matchLength);
              var wrongPart = targetWord.substring(matchLength, typedWord.length);
              var remainingPart = targetWord.substring(typedWord.length);
              
              highlightedText += '<mark class="word-partial">' + correctPart + '</mark>';
              if (wrongPart.length > 0) {
                highlightedText += '<mark class="word-error">' + wrongPart + '</mark>';
              }
              highlightedText += remainingPart;
            } else {
              // Completely wrong from the start
              var wrongLength = Math.min(typedWord.length, targetWord.length);
              var wrongPart = targetWord.substring(0, wrongLength);
              var remainingPart = targetWord.substring(wrongLength);
              highlightedText += '<mark class="word-error">' + wrongPart + '</mark>' + remainingPart;
            }
          }
        } else {
          // Untyped word
          highlightedText += targetWord;
        }
        
        // Add space between words (except for the last word)
        if (i < targetWords.length - 1) {
          highlightedText += ' ';
        }
      }
      
      // Update the element content
      $el.html(highlightedText);
    }

    function removeHighlight(element) {
      var $el = $(element);
      var originalText = $el.data('original-text');
      
      if (originalText) {
        // Restore original text
        $el.text(originalText);
      } else {
        // If no original text stored, remove mark tags manually and store clean text
        var cleanText = $el.text(); // Get text without HTML
        $el.find('mark').each(function() {
          $(this).replaceWith($(this).text());
        });
        // Store the clean text for future use
        $el.data('original-text', cleanText);
      }
    }

    // jQuery plugin style functions for compatibility (defined globally)
    // Ensure jQuery is available before defining plugins
    if (typeof jQuery !== 'undefined') {
      $.fn.mark = function(searchText) {
        return this.each(function() {
          highlightText(this, searchText);
        });
      };

      $.fn.unmark = function() {
        return this.each(function() {
          removeHighlight(this);
        });
      };
      
      console.log('Custom mark.js replacement loaded successfully');
    } else {
      console.error('jQuery not available, cannot define mark/unmark functions');
    }
    
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    document.addEventListener('keydown', event => {
      if(started){
        keyPressCountTmp+=1;
        const keyCode = event.code;

        if(keyCode != "Backspace"){
          cheatDetect.push(keyCode);
        
          //cheat detection
          if(cheatDetect.length >= 10){
            cheatDetect.shift();

            var cheating = true;
            for(var z = 1; z < cheatDetect.length; z++){
              if(cheatDetect[z-1] != cheatDetect[z]){
                cheating = false;
                break;
              }
            }
            if(cheating){
              alert("[점수 조작 방지 알림]");
            }
          }
        }

        if(keyMap.has(keyCode)){
          keyMap.set(keyCode, keyMap.get(keyCode) + 1);
        } else {
          keyMap.set(keyCode, 1);
        }
        
        if(keyCode=="Enter"){
          console.log('Enter pressed - updating sentences');
          keyPressCount += keyPressCountTmp;
          keyPressCountTmp = 0;
          updateScore();
          
          // IMPORTANT: Capture current input before updating sentences
          var currentTypedInput = $('#chatInput').val();
          
          console.log('Before updateSentenceTriplet:', sentenceTriplet);
          updateSentenceTriplet();
          console.log('After updateSentenceTriplet:', sentenceTriplet);
          
          givenSentenceList.push(sentenceTriplet[2]);
          typedSentenceList.push(currentTypedInput);

          // Update content for Before and Current sections (normal text)
          $('#testSentInputBefore').html(sentenceTriplet[0]);
          $('#testSentInput').html(sentenceTriplet[1]);
          
          // For After section: Set plain text first, then apply highlighting
          $('#testSentInputAfter').html(sentenceTriplet[2]);
          
          // Store original text for highlighting purposes after content update
          $('#testSentInputBefore').data('original-text', sentenceTriplet[0]);
          $('#testSentInput').data('original-text', sentenceTriplet[1]);
          $('#testSentInputAfter').data('original-text', sentenceTriplet[2]);
          
          console.log('Updated HTML content:');
          console.log('Before:', sentenceTriplet[0]);
          console.log('Current:', sentenceTriplet[1]);
          console.log('After:', sentenceTriplet[2]);
          console.log('Current typed input:', currentTypedInput);
          
          // Apply highlighting to the After section with the current input that just finished
          removeHighlight($("#testSentInputAfter")[0]);
          if (currentTypedInput && currentTypedInput.trim() !== '') {
            console.log('Applying highlight to After section with:', currentTypedInput);
            highlightText($("#testSentInputAfter")[0], currentTypedInput);
          }
          
          // Update prevInputSent for future reference (though we don't use it for After section now)
          prevInputSent = currentTypedInput;
          $('#chatInput').val("");
          
          // Clear any existing highlighting on the new current sentence
          removeHighlight($("#testSentInput")[0]);
        }
      }
    });

    // Handle real-time highlighting during typing using input event (fires AFTER value changes)
    document.addEventListener('input', event => {
      if(started && event.target && event.target.id === 'chatInput' && sentenceTriplet.length >= 2){
        console.log('Input event triggered - highlighting current sentence');
        removeHighlight($("#testSentInput")[0]);
        var totalInput = event.target.value;
        if (totalInput && totalInput.trim() !== '') {
          highlightText($("#testSentInput")[0], totalInput);
        }
      }
    });
});
    </script>


  <!-- Removed duplicate jQuery loads to fix mark.js conflicts -->
  <script src="js/transit.js"></script>  
  <script src="js/sent_generator.js"></script> 
  <script src="js/sent_generator_kr.js"></script> 
  <script src="js/prg_sent.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/ko.js"></script>
    <!-- Removed duplicate popper, bootstrap, and mark.js - now loaded in head -->
    <script src="data/adjectives.js"></script>
    <script src="data/verbs.js"></script>
    <script src="data/nouns.js"></script>
    <script src="data/simple_words.js"></script>
  </body>
</html>
