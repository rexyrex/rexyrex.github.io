<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rex Typing Game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" type="text/css" href="css/typespeed2.css">
    <style>
      /* Prevent navbar flash during loading */
      #nav-placeholder {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.1s ease;
      }
      #nav-placeholder.loaded {
        visibility: visible;
        opacity: 1;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="/js/common.js"></script>
  </head>

  <body>
    <div id="nav-placeholder"></div>
    
    <!-- Animated Background -->
    <div class="animated-bg">
      <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
      </div>
    </div>

    <div class="container page-load-animation">
      <!-- Header Section -->
      <div class="hero-section-typing">
        <div class="hero-content-typing text-center">
          <div class="typing-avatar card-entrance">
            <div class="avatar-glow"></div>
            <div class="avatar-ring"></div>
            <div class="avatar-inner" id="keyboardIcon">
              <i class="fas fa-keyboard"></i>
        </div>
            <div class="status-indicator"></div>
        </div>
          
          <h1 class="hero-title-typing title-slide-in">
            <span class="title-main">Typing Speed Test</span>
          </h1>

          <div class="rankings-inline">
            <button id="highScoreBtnDaily" class="ranking-btn-inline card-entrance delay-1" onclick="openHighscoresModal(true)">
              <i class="fas fa-calendar-day"></i>
              <span>ì˜¤ëŠ˜ ìˆœìœ„</span>
            </button>
            
            <button id="highScoreBtnAll" class="ranking-btn-inline card-entrance delay-2" onclick="openHighscoresModal(false)">
              <i class="fas fa-crown"></i>
              <span>ì—­ëŒ€ ìˆœìœ„</span>
            </button>
            

          </div>
          </div>
        </div>

      <!-- Main Landing Button -->
      <button id="startBtn" class="mega-start-btn button-pop-in" onclick="showModeSelection()">
        <div class="mega-btn-bg"></div>
        <div class="mega-btn-content">
          <div class="mega-btn-icon">
            <i class="fas fa-keyboard"></i>
          </div>
          <div class="mega-btn-text">
            <span class="mega-btn-title">ê²Œì„ ì‹œì‘</span>
            <span class="mega-btn-subtitle">Click to Start Typing</span>
        </div>
        </div>
        <div class="mega-btn-pulse"></div>
        <div class="mega-btn-glow"></div>
      </button>

      <!-- Main Game Section -->
      <div id="grp1" class="game-section" style="display: none;">
        <!-- Mode Selection (initially hidden) -->
        <div class="mode-selection-section" id="modeSelectionSection" style="display: none;">
          <div class="section-header-card">
            <div class="section-badge">
              <i class="fas fa-gamepad"></i>
              <span>ê²Œì„ ëª¨ë“œ ì„ íƒ</span>
            </div>
          </div>
          
          <div class="mode-grid" id="modeGrp">
            <button id="chMod1" type="button" class="mode-card" onclick="selectModeAndStart(1)">
              <div class="mode-icon">
                <i class="fas fa-language"></i>
            </div>
              <div class="mode-content">
                <div class="mode-title">í•œíƒ€</div>
                <div class="mode-description">í•œê¸€ íƒ€ì</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod2" type="button" class="mode-card" onclick="selectModeAndStart(2)">
              <div class="mode-icon">
                <i class="fas fa-building"></i>
            </div>
              <div class="mode-content">
                <div class="mode-title">ì´í¬ë„·</div>
                <div class="mode-description">íšŒì‚¬ ëª¨ë“œ</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod3" type="button" class="mode-card" onclick="selectModeAndStart(3)">
              <div class="mode-icon">
                <i class="fas fa-globe-americas"></i>
            </div>
              <div class="mode-content">
                <div class="mode-title">ì˜íƒ€</div>
                <div class="mode-description">English</div>
              </div>
              <div class="mode-glow"></div>
            </button>
            
            <button id="chMod4" type="button" class="mode-card" onclick="selectModeAndStart(4)">
              <div class="mode-icon">
                <i class="fas fa-code"></i>
              </div>
              <div class="mode-content">
                <div class="mode-title">ê°œë°œì</div>
                <div class="mode-description">Programming</div>
              </div>
              <div class="mode-glow"></div>
            </button>
          </div>
            </div>

            </div>

      <!-- Countdown Section -->
      <div id="countdownSection" class="countdown-section" style="display: none;">
        <div class="countdown-content">
          <div class="countdown-icon">
            <i class="fas fa-stopwatch"></i>
          </div>
          <div class="countdown-text">
            <h2 class="countdown-title">ì¤€ë¹„í•˜ì„¸ìš”!</h2>
            <p class="countdown-subtitle">ê²Œì„ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤</p>
          </div>
          <div class="countdown-timer">
            <span id="countdownNumber">5</span>
          </div>
          <div class="countdown-progress">
            <div id="countdownBar" class="countdown-bar"></div>
          </div>
        </div>
      </div>

      <!-- Game Area (only appears when game starts) -->
      <div id="grp2" class="game-area-main" style="display: none;">
        <!-- Progress Bar -->
        <div class="progress-section">
          <div id="prgBar" class="progress-modern">
            <div class="progress-bar-modern" 
                 role="progressbar" aria-valuenow="100" aria-valuemin="0" 
                 aria-valuemax="100">60</div>
                  </div>
                </div>
        
        <!-- Text Display Areas -->
        <div class="text-display-modern">
          <div class="text-section">
            <span id="testSentInputBefore" class="text-previous unselectable" style="pointer-events:none;"></span>
            </div>
          
          <div class="text-section">
            <span id="testSentInput" class="text-current unselectable" style="pointer-events:none;"></span>
                  </div>
          
          <div class="text-section">
            <span id="testSentInputAfter" class="text-next unselectable" style="pointer-events:none;"></span>
                </div>
          
          <!-- Input Field -->
          <div class="input-section">
            <input id="chatInput" class="input-modern" autocomplete="off" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..."/>
            </div>

          <!-- Comment Display -->
          <div class="comment-section text-center">
            <p id="comment" class="comment-modern" style="visibility:hidden;">ddd</p>
          </div>
        </div>
      </div>



      <!-- Result Modal -->
      <div id="testModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="resultModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resultModalTitle">
                <i class="fas fa-trophy"></i> ê²°ê³¼
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="result-stats">
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-medal"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">ë“±ê¸‰</div>
                    <div id="resGrade" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-tachometer-alt"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">ì ìˆ˜</div>
                    <div id="resScore" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">ìƒëŒ€ í‰ê°€</div>
                    <div id="resComp" class="stat-value">-</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon">
                    <i class="fas fa-bullseye"></i>
                  </div>
                  <div class="stat-content">
                    <div class="stat-label">ì •í™•ë„</div>
                    <div id="resAccuracy" class="stat-value">-</div>
                  </div>
                </div>
              </div>

              <div class="text-center mb-3">
                <button id="openSaveCollapseBtn" onclick="openSaveCollapseBtn()" class="hero-btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  <span class="btn-text">
                    <i class="fas fa-save"></i>
                    ê¸°ë¡ ì €ì¥
                  </span>
                  <div class="btn-shine"></div>
                </button>
              </div>

              <div class="collapse" id="collapseExample">
                <div class="modal-card">
                  <!-- Save Form (shown initially) -->
                  <div id="saveForm">
                    <div class="form-group">
                      <label for="highscoreId" class="form-label">ì´ë¦„</label>
                      <input id="highscoreId" class="form-control" autocomplete="off" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" />
                      <div id="saveErrorMessage" class="invalid-feedback" style="display: none;"></div>
                    </div>
                    <button class="hero-btn btn-primary w-100" type="button" onclick="saveHighscore();">
                      <span class="btn-text">
                        <i class="fas fa-check"></i>
                        ê¸°ë¡ ì €ì¥
                      </span>
                      <div class="btn-shine"></div>
                    </button>
                  </div>
                  
                  <!-- Success Message (shown after successful save) -->
                  <div id="saveSuccess" style="display: none;">
                    <div class="text-center">
                      <div class="save-success-icon">
                        <i class="fas fa-check-circle"></i>
                      </div>
                      <h4 class="save-success-title">ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
                      <p id="saveSuccessMessage" class="save-success-text"></p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-center mb-3">
                <button id="toggleIncorrectWords" class="modern-btn btn-secondary" type="button" onclick="toggleIncorrectWordsList()">
                  <i id="toggleIcon" class="fas fa-chevron-down"></i> í‹€ë¦° ë‹¨ì–´ ëª©ë¡
                </button>
              </div>

              <div class="collapse" id="collapseExample2">
                <div class="error-list-card">
                  <ul id="incList" class="error-list"></ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Highscore Modal -->
      <div id="highscoreModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="highscoreModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="highscoreModalTitle">
                <i class="fas fa-trophy"></i> íƒ€ì ì†ë„ ìˆœìœ„
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            
            <div class="modal-body">
              <nav class="nav nav-pills nav-justified mb-3">
                <a id="korScoreTab" class="nav-item nav-link active" href="#">
                  <i class="fas fa-language"></i> í•œíƒ€
                </a>
                <a id="engScoreTab" class="nav-item nav-link" href="#">
                  <i class="fas fa-globe-americas"></i> ì˜íƒ€
                </a>
                <a id="prgScoreTab" class="nav-item nav-link" href="#">
                  <i class="fas fa-code"></i> ê°œë°œì
                </a>
              </nav>

              <div class="score-title-card">
                <h4 id="scoreTitle" class="score-title">í•œíƒ€ ìˆœìœ„</h4>
                <p class="score-subtitle">(100ìœ„ ê¹Œì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.)</p>
              </div>

              <div class="tableFixHead">
                <table id="highScoreTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col"><i class="fas fa-medal"></i> ìˆœìœ„</th>
                      <th scope="col"><i class="fas fa-user"></i> ì´ë¦„</th>
                      <th scope="col"><i class="fas fa-star"></i> ë“±ê¸‰</th>
                      <th scope="col"><i class="fas fa-tachometer-alt"></i> ì ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div id="highLoading" class="loading-indicator" style="visibility:hidden;">
                  <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>



      <!-- Version Modal -->
      <div id="versionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="versionModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="versionModalTitle">
                <i class="fas fa-code-branch"></i> Version History
              </h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="tableFixHead">
                <table id="versionTable" class="table table-striped table-dark">
                  <thead>
                    <tr>
                      <th scope="col"><i class="fas fa-tag"></i> ë²„ì „</th>
                      <th scope="col"><i class="fas fa-list"></i> ë³€ê²½ ì‚¬í•­</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="modern-btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times"></i> ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Removed old jQuery 1.11.1 to fix conflicts -->

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.8/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyANe3HNZoH-3vYVA4tyZRLA_qmsPYmfvbE",
        authDomain: "rextypingspeed.firebaseapp.com",
        projectId: "rextypingspeed",
        storageBucket: "rextypingspeed.appspot.com",
        messagingSenderId: "329903137752",
        appId: "1:329903137752:web:749c515f41a710b265c8ad",
        measurementId: "G-77L95J37F1"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>


    <script>

    var db;
    
    var progress;
    var secondsPassed;
    var timeLimit;
    var started;
    var keyPressCount;
    var keyPressCountTmp;
    
    var correctWordCount;
    var incorrectWordCount;
    
    var incWordArr;
    var attmpWordArr;

    var timerStartedOnce;

    var startSentenceTime;

    var score;
    var accuracy;

    var scoreSaved;

    var sentenceTriplet;
    var prevInputSent;

    var countingDown;

    var mode;

    var daily = false;

    const cheatDetect = [];

    var givenSentenceList;
    var typedSentenceList;

    const keyMap= new Map();

    const version = 8;

    var uuid = uuidv4();
    
    var level = [
      {"s" : 200, "l" : 'ì£„ì†¡í•œë°... ì†ê°€ë½ 2ê°œì„¸ìš”?'}, 
      {"s" : 300, "l" : 'ë¶„ë°œí•˜ì…”ì•¼ê² ì–´ìš”'}, 
      {"s" : 380, "l" : 'ì´ì •ë„ë©´ í‰íƒ€'}, 
      {"s" : 420, "l" : 'í‰ê·  ì´ìƒ'}, 
      {"s" : 470, "l" : 'ë¹ ë¥¸í¸'}, 
      {"s" : 520, "l" : 'ê°œë°œì'}, 
      {"s" : 560, "l" : 'pcì¹´í†¡ ë§ì´ í•œê±° í‹°ë‚˜ë„¤ (ì„í¬ì£¼ê¸‰)'}, 
      {"s" : 600, "l" : 'íƒ€ì ë§ê³  ì˜í•˜ëŠ”ê²Œ ì—†ì„ í™•ë¥  ë†’ìŒ'}, 
      {"s" : 650, "l" : 'ëŒ€íšŒ ë‚˜ê°€ë„ ë ë“¯'}, 
      {"s" : 700, "l" : 'íƒ€ì ì‹ '}, 
      {"s" : 740, "l" : 'í•´í‚¹ ìœ ì €'},
      {"s" : 780, "l" : 'ê¸°ê³„'},
      {"s" : 820, "l" : 'ì´ˆì›”ì'},
      {"s" : 999999, "l" : 'ë ìš©'}
    ];

    var englevel = [
      {"s" : 20, "l" : 'Slowpoke'}, 
      {"s" : 30, "l" : 'Practice makes perfect'}, 
      {"s" : 40, "l" : 'Not bad'}, 
      {"s" : 50, "l" : 'Above Average'}, 
      {"s" : 60, "l" : 'Quite fast'}, 
      {"s" : 70, "l" : 'Developer'}, 
      {"s" : 80, "l" : 'Bunny Typer'}, 
      {"s" : 90, "l" : 'Professional Typer'}, 
      {"s" : 100, "l" : 'Typing God'}, 
      {"s" : 110, "l" : 'Hacker'},
      {"s" : 120, "l" : 'Machine'},
      {"s" : 130, "l" : 'Ridonculous'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    var prglevel = [
      {"s" : 20, "l" : 'ë°±ìˆ˜'}, 
      {"s" : 27, "l" : 'ì‹ ì…'}, 
      {"s" : 32, "l" : 'ì£¼ì„'}, 
      {"s" : 38, "l" : 'ëŒ€ë¦¬'}, 
      {"s" : 45, "l" : 'ê³¼ì¥'}, 
      {"s" : 52, "l" : 'ì°¨ì¥'}, 
      {"s" : 59, "l" : 'ë¶€ì¥'}, 
      {"s" : 65, "l" : 'ì´ì‚¬'}, 
      {"s" : 70, "l" : 'ì‚¬ì¥'}, 
      {"s" : 75, "l" : 'íšŒì¥'}, 
      {"s" : 80, "l" : 'ëŒ€í†µë ¹'},
      {"s" : 85, "l" : 'Elon Musk'},
      {"s" : 90, "l" : 'ë‡Œë¡œ í”„ë¡œê·¸ë˜ë°í•˜ëŠ” ì™¸ê³„ì¸'},
      {"s" : 999999, "l" : 'OMG'}
    ];

    const scoreTabs = ['korScoreTab','engScoreTab', 'prgScoreTab'];
    
    $(function () {
      


      $('#korScoreTab').on('click', function (e) {
        setScoreTab('kor');
      })

      $('#engScoreTab').on('click', function (e) {
        setScoreTab('eng');
      })

      $('#prgScoreTab').on('click', function (e) {
        setScoreTab('prg');
      })

      $('#verTitle').text("Ver " + version);
      changeMode(1);
      db = firebase.firestore();
      saveLogin();
      checkVersion();
      timerStartedOnce = false;
      reset();

      //var textgen = new TextGen();
      //alert(textgen.sentence());
    });

    function setScoreTab(tabType){
      // Update custom modal tabs with subtle styling
      $('#customKorTab, #customEngTab, #customPrgTab').css({
        'background': 'transparent',
        'color': '#6c757d',
        'border': 'none',
        'box-shadow': 'none',
        'transform': 'translateY(0)'
      });
      
      if(tabType=='kor'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("í•œíƒ€ ìˆœìœ„" + (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#customScoreTitle').text("í•œíƒ€ ìˆœìœ„" + (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#korScoreTab').addClass('active');
        $('#customKorTab').css({
          'background': '#ffffff',
          'color': '#495057',
          'border': '1px solid #dee2e6',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.06)'
        });
        loadHighscoreData('kor');
      } else if(tabType=='eng'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("English Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#customScoreTitle').text("English Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#engScoreTab').addClass('active');
        $('#customEngTab').css({
          'background': '#ffffff',
          'color': '#495057',
          'border': '1px solid #dee2e6',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.06)'
        });
        loadHighscoreData('eng');
      } else if(tabType=='prg'){
        for(var i=0; i<scoreTabs.length; i++){
          $('#' + scoreTabs[i]).removeClass('active');
        }
        $('#scoreTitle').text("Programmer Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#customScoreTitle').text("Programmer Ranking"+ (daily ? ' (' + moment().format('MM-DD-YYYY') + ')' : ' (ì—­ëŒ€)'));
        $('#prgScoreTab').addClass('active');
        $('#customPrgTab').css({
          'background': '#ffffff',
          'color': '#495057',
          'border': '1px solid #dee2e6',
          'box-shadow': '0 2px 4px rgba(0,0,0,0.06)'
        });
        loadHighscoreData('prg');
      }
    }

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function saveLogin(){
      db.collection("login").add({
            uuid: uuid,
            navigator: navigator.userAgent,
            date: moment().format('MM-DD-YYYY HH:mm:ss')
          }).then((docRef) => {
            
          })
          .catch((error) => {

          });
    }

    function checkVersion(){
      db.collection("version").orderBy("ver", "desc").limit(1)
      .get()
      .then((querySnapshot) => {
          var serverVer = 100000;
          querySnapshot.forEach((doc) => {
              serverVer = parseInt(doc.data().ver);
          });

          if(version < serverVer){
            alert("ìºì‹œë¥¼ ì§€ì›Œì£¼ì„¸ìš”. (Client ver: " + version + ", Server ver: " + serverVer + ")");
            //window.location.reload(true);
            $('#startBtn').text("ìºì‹œë¥¼ ì§€ì›Œì£¼ì„¸ìš”.");
            $('#startBtn').attr('disabled', true);

            fadeOut("grp2");
            fadeOut("highScoreBtnDaily");
            fadeOut("highScoreBtnAll")
            fadeOut("modeGrp");
          }

      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }

    function openVersionModal(){
      $('#versionModal').modal('show');

      db.collection("version").orderBy("ver", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var versionList = [];
          querySnapshot.forEach((doc) => {
              //console.log(doc.id, " => ", doc.data());
              versionList.push(doc.data());
          });

          $('#versionTable tbody').empty();
          for(var i=0; i<versionList.length; i++){
            $('#versionTable tbody').append("<tr><td>" + versionList[i].ver + "</td><td>"+ versionList[i].desc + "</td>");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });

    }

    function changeMode(m){
      // if(m==4){
      //   alert("ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤");
      //   return;
      // }
      mode = m;
      
      // Remove active class from all mode buttons
      $('.mode-card').removeClass('active');
      
      // Add active class to selected mode button
      $('#chMod'+m).addClass('active');
    }

    function openSaveCollapseBtn(){
      $('#openSaveCollapseBtn').css("visibility", "hidden");
      // Reset save form state when opening
      resetSaveForm();
    }

    function resetSaveForm(){
      clearSaveError();
      $('#saveForm').show();
      $('#saveSuccess').hide();
      $('#highscoreId').val('');
    }

    function toggleIncorrectWordsList(){
      var $collapse = $('#collapseExample2');
      var $icon = $('#toggleIcon');
      
      if($collapse.hasClass('show')){
        // Currently open, so close it
        $collapse.removeClass('show');
        $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
      } else {
        // Currently closed, so open it
        $collapse.addClass('show');
        $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
      }
    }

    function showSaveError(message) {
      $('#highscoreId').addClass('is-invalid');
      $('#saveErrorMessage').text(message).show();
    }

    function clearSaveError() {
      $('#highscoreId').removeClass('is-invalid');
      $('#saveErrorMessage').hide();
    }

    function showSaveSuccess(message) {
      $('#saveForm').hide();
      $('#saveSuccessMessage').text(message);
      $('#saveSuccess').show();
    }

    function updateSentenceTriplet(){
      if(sentenceTriplet.length == 0){
        sentenceTriplet.push(generateSentence());
        sentenceTriplet.push(generateSentence());
        sentenceTriplet[2] = '.';
      } else {
        //triplet is of length 2 or 3
        sentenceTriplet[2] = sentenceTriplet[1];
        sentenceTriplet[1] = sentenceTriplet[0];
        sentenceTriplet[0] = generateSentence();
      }
    }

    function saveHighscore(){
      clearSaveError(); // Clear any previous error messages
      
      var username = $('#highscoreId').val().trim();
      
      if(username.length < 2){
        showSaveError("ì´ë¦„ì´ ë„ˆë¬´ ì§§ì•„ìš”. (ìµœì†Œ 2ê¸€ì)");
        return;
      } else if(username.length > 8){
        showSaveError("ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”. (ìµœëŒ€ 8ê¸€ì)");
        return;
      }

      if(score<0 || isNaN(score)){
        showSaveError("ê¸°ë¡ ì €ì¥ ë¶ˆê°€ - í•œ ë‹¨ì–´ë„ ì•ˆì¹˜ì…¨ë„¤ìš” :(");
        return;
      }

      if(!scoreSaved){
        scoreSaved = true;
        addHighscore(username, score, getGrade(), Math.round(accuracy*100)+'%');   
        updateAnonHighscore();     
      } else {
        showSaveError("ì´ë¯¸ ê¸°ë¡ ì €ì¥í•˜ì…¨ë„¤ìš”~");
      }
    }

    function addAnonHighscore(score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      db.collection(collectionName).add({
            uuid: uuid,
            id: "",
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            
          })
          .catch((error) => {
            // Error handled silently
          });
    }

    function updateAnonHighscore(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'recordsAnon'; break;
        case 2: collectionName = 'recordsAnon'; break;
        case 3: collectionName = 'engRecordsAnon'; break;
        case 4: collectionName = 'prgRecordsAnon'; break;
      }
      var tmpId = $('#highscoreId').val();
      db.collection(collectionName).where("uuid", "==", uuid).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          db.collection(collectionName).doc(doc.id).update({
              id: tmpId,
          })
          .then(() => {
            
          })
        })
      })
    }

    function addHighscore(username, score, rank, accuracy){
      var keyArr = Array.from(keyMap, ([name, value]) => ({ name, value }));
      var userExists = false;
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      //Check if username exists
      db.collection(collectionName).where("id", "==", username).get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            userExists = true;
            //console.log(doc.id, " => ", doc.data());
            //username exists and new highscore reached
            if(doc.data().score < score){
              db.collection(collectionName).doc(doc.id).update({
                  score: score,
                  accuracy: accuracy,
                  correctWordCount : correctWordCount,
                  incorrectWordCount : incorrectWordCount,
                  givenSentenceList : givenSentenceList,
                  typedSentenceList : typedSentenceList,
                  keyMap : keyArr,
                  rank: rank,
                  clientVersion: version,
                  mode: mode,
                  cheatDetect: cheatDetect,
                  keyPressCount: keyPressCount,
                  keyPressCountTmp: keyPressCountTmp,
                  date: moment().format('MM-DD-YYYY HH:mm'),
                  day: moment().format('MM-DD-YYYY')
              })
              .then(() => {
                showSaveSuccess("ê¸°ë¡ì„ ê°±ì‹ í•˜ì…¨ìŠµë‹ˆë‹¤! (" + doc.data().score + " â†’ " + score + "ì )");
              })
            } else {
              showSaveError("ë” ë†’ì€ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ìµœê³  ê¸°ë¡: " + doc.data().score + "ì )");
            }
        });
        //Add new user
        if(!userExists){
          db.collection(collectionName).add({
            id: username,
            score: score,
            accuracy: accuracy,
            correctWordCount : correctWordCount,
            incorrectWordCount : incorrectWordCount,
            givenSentenceList : givenSentenceList,
            typedSentenceList : typedSentenceList,
            keyMap : keyArr,
            rank: rank,
            clientVersion: version,
            mode: mode,
            cheatDetect: cheatDetect,
            keyPressCount: keyPressCount,
            keyPressCountTmp: keyPressCountTmp,
            date: moment().format('MM-DD-YYYY HH:mm'),
            day: moment().format('MM-DD-YYYY')
          }).then((docRef) => {
            showSaveSuccess("ìƒˆë¡œìš´ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (" + score + "ì )");
          })
          .catch((error) => {
            showSaveError("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          });
        }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }



    function openHighscoresModal(dly){

      daily = dly;

      $('#highLoading').css("visibility", "visible");
      
      setScoreTab('kor');

      // Use the WORKING custom modal approach instead of Bootstrap
      
      // Create custom ranking modal
      if ($('#customRankingModal').length === 0) {
        var modalContent = `
          <div id="customRankingModal" style="position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; width: 90vw !important; max-width: 900px !important; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important; border: 1px solid #dee2e6 !important; border-radius: 16px !important; z-index: 999999 !important; color: #495057 !important; box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important; pointer-events: auto !important; max-height: 85vh !important; overflow: hidden !important; animation: modalSlideIn 0.3s ease-out !important;">
            <div style="padding: 25px 30px !important; border-bottom: 1px solid #dee2e6 !important; background: rgba(255,255,255,0.8) !important;">
              <h3 style="margin: 0 !important; color: #343a40 !important; display: inline-block !important; font-weight: 600 !important; font-size: 24px !important;">ğŸ† íƒ€ì ì†ë„ ìˆœìœ„</h3>
              <button onclick="closeCustomRankingModal();" style="float: right !important; background: #f8f9fa !important; color: #6c757d !important; border: 1px solid #dee2e6 !important; padding: 8px 12px !important; border-radius: 50% !important; cursor: pointer !important; font-size: 18px !important; width: 40px !important; height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; transition: all 0.3s ease !important;" onmouseover="this.style.background='#e9ecef'; this.style.color='#495057'" onmouseout="this.style.background='#f8f9fa'; this.style.color='#6c757d'">&times;</button>
            </div>
            <div style="padding: 25px 30px !important;">
              <nav style="margin-bottom: 25px !important; display: flex !important; gap: 6px !important; background: #f8f9fa !important; padding: 4px !important; border-radius: 10px !important; border: 1px solid #e9ecef !important;">
                <button id="customKorTab" onclick="setScoreTab('kor')" style="background: #ffffff !important; color: #495057 !important; border: 1px solid #dee2e6 !important; padding: 10px 18px !important; border-radius: 6px !important; cursor: pointer !important; font-weight: 500 !important; font-size: 14px !important; transition: all 0.3s ease !important; flex: 1 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.06) !important;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.06)';">í•œíƒ€</button>
                <button id="customEngTab" onclick="setScoreTab('eng')" style="background: transparent !important; color: #6c757d !important; border: none !important; padding: 10px 18px !important; border-radius: 6px !important; cursor: pointer !important; font-weight: 500 !important; font-size: 14px !important; transition: all 0.3s ease !important; flex: 1 !important;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='transparent'">ì˜íƒ€</button>
                <button id="customPrgTab" onclick="setScoreTab('prg')" style="background: transparent !important; color: #6c757d !important; border: none !important; padding: 10px 18px !important; border-radius: 6px !important; cursor: pointer !important; font-weight: 500 !important; font-size: 14px !important; transition: all 0.3s ease !important; flex: 1 !important;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='transparent'">ê°œë°œì</button>
              </nav>
              <div style="text-align: center !important; margin-bottom: 20px !important;">
                <h4 id="customScoreTitle" style="color: #343a40 !important; margin: 0 0 8px 0 !important; font-weight: 600 !important; font-size: 20px !important;">í•œíƒ€ ìˆœìœ„</h4>
                <p style="color: #6c757d !important; margin: 0 !important; font-size: 14px !important;">(100ìœ„ ê¹Œì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.)</p>
              </div>
              <div style="max-height: 420px !important; overflow-y: auto !important; border-radius: 10px !important; background: #ffffff !important; border: 1px solid #e9ecef !important;">
                <table id="customHighScoreTable" style="width: 100% !important; border-collapse: collapse !important; background: transparent !important; color: #495057 !important;">
                  <thead style="background: linear-gradient(135deg, #6c757d, #495057) !important; position: sticky !important; top: 0 !important; z-index: 10 !important;">
                    <tr>
                      <th style="padding: 16px 20px !important; border: none !important; color: white !important; text-align: left !important; font-weight: 600 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;">ìˆœìœ„</th>
                      <th style="padding: 16px 20px !important; border: none !important; color: white !important; text-align: left !important; font-weight: 600 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;">ì´ë¦„</th>
                      <th style="padding: 16px 20px !important; border: none !important; color: white !important; text-align: left !important; font-weight: 600 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;">ë“±ê¸‰</th>
                      <th style="padding: 16px 20px !important; border: none !important; color: white !important; text-align: left !important; font-weight: 600 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.5px !important;">ì ìˆ˜</th>
                    </tr>
                  </thead>
                  <tbody id="customTableBody">
                  </tbody>
                </table>
                <div id="customLoading" style="text-align: center !important; padding: 40px !important; color: #6c757d !important; display: none !important; font-size: 16px !important;">
                  <div style="display: inline-block !important; width: 20px !important; height: 20px !important; border: 3px solid #e9ecef !important; border-top: 3px solid #6c757d !important; border-radius: 50% !important; animation: spin 1s linear infinite !important; margin-right: 10px !important;"></div>
                  Loading...
                </div>
              </div>
            </div>
          </div>
          <style>
            @keyframes modalSlideIn {
              from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
              to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            #customRankingModal::-webkit-scrollbar {
              width: 6px;
            }
            #customRankingModal::-webkit-scrollbar-track {
              background: rgba(255,255,255,0.1);
              border-radius: 3px;
            }
            #customRankingModal::-webkit-scrollbar-thumb {
              background: rgba(255,255,255,0.3);
              border-radius: 3px;
            }
            #customRankingModal::-webkit-scrollbar-thumb:hover {
              background: rgba(255,255,255,0.5);
            }
          </style>
        `;
        
        $('body').append(modalContent);
        
        // Add backdrop with subtle effect
        $('body').append('<div id="customRankingBackdrop" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0,0,0,0.4) !important; backdrop-filter: blur(4px) !important; z-index: 999998 !important; animation: backdropFadeIn 0.3s ease-out !important;" onclick="closeCustomRankingModal();"></div><style>@keyframes backdropFadeIn { from { opacity: 0; } to { opacity: 1; } }</style>');
      }
      
    }
    
    function closeCustomRankingModal() {
      $('#customRankingModal').remove();
      $('#customRankingBackdrop').remove();
    }

    function loadHighscoreData(scoreType){
      var collectionName = '';
      if(!daily){
        if(scoreType=='kor'){
          collectionName = "records2";
        } else if(scoreType == 'eng'){
          collectionName = "engRecords";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecords";
        }
      } else {
        //daily
        if(scoreType=='kor'){
          collectionName = "recordsAnon";
        } else if(scoreType == 'eng'){
          collectionName = "engRecordsAnon";
        } else if(scoreType == 'prg'){
          collectionName = "prgRecordsAnon";
        }
      }

      if(!daily){
        db.collection(collectionName).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#customLoading').hide();
            $('#highScoreTable tbody').empty();
            $('#customTableBody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + highList[i].id + "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
              var rankBadge = '';
              var rankColor = '#6c757d';
              if (i < 3) {
                var medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                var colors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                rankBadge = medals[i];
                rankColor = colors[i];
              }
              $('#customTableBody').append('<tr style="transition: all 0.3s ease !important; border-bottom: 1px solid #f8f9fa !important;" onmouseover="this.style.background=\'#f8f9fa\'; this.style.transform=\'translateX(3px)\';" onmouseout="this.style.background=\'transparent\'; this.style.transform=\'translateX(0)\';"><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 600 !important; font-size: 15px !important;"><span style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 28px !important; height: 28px !important; background: ' + rankColor + ' !important; color: white !important; border-radius: 50% !important; font-size: 13px !important; font-weight: 600 !important; margin-right: 8px !important;">' + (rankBadge || (i+1)) + '</span></td><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 500 !important; font-size: 14px !important;">' + highList[i].id + '</td><td style="padding: 14px 20px !important; color: #6c757d !important; font-weight: 500 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">' + highList[i].rank + '</td><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 600 !important; font-size: 15px !important;">' + highList[i].score + '</td></tr>');
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      } else {
        //daily
        db.collection(collectionName).where("day", "==", moment().format('MM-DD-YYYY')).orderBy("score", "desc").limit(100)
        .get()
        .then((querySnapshot) => {
          var highList = [];
            querySnapshot.forEach((doc) => {
                //console.log(doc.id, " => ", doc.data());
                highList.push(doc.data());
            });
            $('#highLoading').css("visibility", "hidden");
            $('#customLoading').hide();
            $('#highScoreTable tbody').empty();
            $('#customTableBody').empty();
            for(var i=0; i<highList.length; i++){
              $('#highScoreTable tbody').append("<tr><th scope='row'>" + (i+1) + "</th><td>" + (highList[i].id == '' ?  'ìµëª… ìœ ì €' : highList[i].id)+ "</td><td>"+ highList[i].rank + "</td><td>"+ highList[i].score + "</td>");
              var rankBadge = '';
              var rankColor = '#6c757d';
              if (i < 3) {
                var medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                var colors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                rankBadge = medals[i];
                rankColor = colors[i];
              }
              $('#customTableBody').append('<tr style="transition: all 0.3s ease !important; border-bottom: 1px solid #f8f9fa !important;" onmouseover="this.style.background=\'#f8f9fa\'; this.style.transform=\'translateX(3px)\';" onmouseout="this.style.background=\'transparent\'; this.style.transform=\'translateX(0)\';"><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 600 !important; font-size: 15px !important;"><span style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 28px !important; height: 28px !important; background: ' + rankColor + ' !important; color: white !important; border-radius: 50% !important; font-size: 13px !important; font-weight: 600 !important; margin-right: 8px !important;">' + (rankBadge || (i+1)) + '</span></td><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 500 !important; font-size: 14px !important;">' + (highList[i].id == '' ? 'ìµëª… ìœ ì €' : highList[i].id) + '</td><td style="padding: 14px 20px !important; color: #6c757d !important; font-weight: 500 !important; font-size: 13px !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">' + highList[i].rank + '</td><td style="padding: 14px 20px !important; color: #495057 !important; font-weight: 600 !important; font-size: 15px !important;">' + highList[i].score + '</td></tr>');
            }
        })
        .catch((error) => {
            console.log("Error getting documents: ", error);
        });
      }
      
    }

    function checkRank(){
      var collectionName = '';
      switch(mode){
        case 1: collectionName = 'records2'; break;
        case 2: collectionName = 'records2'; break;
        case 3: collectionName = 'engRecords'; break;
        case 4: collectionName = 'prgRecords'; break;
      }
      db.collection(collectionName).orderBy("score", "desc").limit(100)
      .get()
      .then((querySnapshot) => {
         var highList = [];
         var i = 0;
         var place = 101;
         var tmpSaved = false;
          querySnapshot.forEach((doc) => {
              highList.push(doc.data());
              i+=1;
              if(score>doc.data().score && !tmpSaved){
                tmpSaved = true;
                place = i;
              }
          });

          if(place < 101){
            $('#resComp').text("ìƒìœ„" + Math.round(place/i*100) + "% (" + i + "ëª… ì¤‘ " + place + "ë“±)" );
          } else if(i < 101){
            $('#resComp').text(i + "ëª… ì¤‘ ê¼´ë“±");
          } else {
            $('#resComp').text("100ë“± ì•ˆì— ëª»ë“¤ì—ˆì–´ìš”");
          }
      })
      .catch((error) => {
          console.log("Error getting documents: ", error);
      });
    }
    
    function reset(){
      
      // Clear any active countdown timer
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      uuid = uuidv4();

      started = false;
      countingDown = false;
      progress = 0;
      secondsPassed = 0;
      keyPressCount = 0;
      keyPressCountTmp = 0;
      timeLimit = 60;
      scoreSaved = false;
      
      // Reset smooth animation timer
      window.gameStartTime = null;
      
      correctWordCount = 0;
      incorrectWordCount = 0;
      score = 0;
      accuracy = 0;
      incWordArr = [];
      attmpWordArr = [];

      sentenceTriplet = [];
      prevInputSent = "";

      typedSentenceList = [];
      givenSentenceList = [];

      keyMap.clear();
      
      // Clear content, animations, and data attributes
      $('#testSentInput').html('').removeData('original-text');
      $('#testSentInputBefore').html('').removeData('original-text');
      $('#testSentInputAfter').html('').removeData('original-text');
      $('#chatInput').val('');
      
      // Reset progress bar
      var $progressBar = $(".progress-bar-modern");
      var $progressContainer = $(".progress-modern");
      $progressBar.removeClass('warning danger').css("width", "100%").text("60");
      $progressContainer.removeClass('warning danger');
      
      // Reset save form state
      resetSaveForm();
      
      // Reset all animation classes and structure
      $('.hero-section-typing').show().removeClass('menu-fade-out');
      $('#startBtn').show().removeClass('menu-fade-out');
      $('#modeSelectionSection').hide();
      $('#grp1').hide(); // Hide game section container
      $('#grp2').removeClass('game-start-transition').hide();
      $('#countdownSection').hide().removeClass('text-reveal menu-fade-out'); // Hide countdown section
      $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
      $('#testSentInput').removeClass('text-reveal');
      $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
      $('#chatInput').removeClass('input-focus-ready');
      $('#startBtn').removeClass('countdown-pulse').html('<div class="mega-btn-bg"></div><div class="mega-btn-content"><div class="mega-btn-icon"><i class="fas fa-keyboard"></i></div><div class="mega-btn-text"><span class="mega-btn-title">ê²Œì„ ì‹œì‘</span><span class="mega-btn-subtitle">Click to Start Typing</span></div></div><div class="mega-btn-pulse"></div><div class="mega-btn-glow"></div>');
      $('#startBtn').attr('onclick', 'showModeSelection()');
      
      // Clear any comment visibility
      $('#comment').css("visibility", "hidden");
      
      // Reset countdown display
      if (document.getElementById('countdownNumber')) {
        document.getElementById('countdownNumber').textContent = '5';
      }
      if (document.getElementById('countdownBar')) {
        document.getElementById('countdownBar').style.width = '100%';
      }
    }

    function retry(){
      reset();
      // Don't call start() directly, let startCountDown() handle the flow
    }

    function fadeIn(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      //animate(elemId, "animateFadeIn", function(){$('#' + elemId).css("visibility", "visible").css("opacity", 1);});
      $('#' + elemId).transition({opacity:1},4000, "snap"); 
    }

    function fadeIn2(elemId){
      $('#' + elemId).css("visibility", "visible").css("opacity", 0);
      $('#' + elemId).transition({opacity:0.27},4000, "snap");
    }

    function fadeOut(elemId){
      $('#' + elemId).css("opacity", 1);
      $('#' + elemId).transition({opacity:0}, 4000, "snap", function(){$('#' + elemId).css("visibility", "hidden").css("opacity", 0);});
    }

    function animate(elemId, anim, fn){
      //console.log("animating : " + elemId + ", " + anim);
      $('#' + elemId).addClass(anim);
      $('#' + elemId).on("animationend", function(){
        fn();
        $(this).removeClass(anim);
      });
    }

    function showModeSelection() {

      
      // Ensure we start from a clean state
      $('#grp2').hide();
      $('#countdownSection').hide();
      $('#modeSelectionSection').hide().removeClass('text-reveal menu-fade-out');
      $('#grp1').removeClass('menu-fade-out');
      
      // Show hero section and button if they're not visible
      $('.hero-section-typing').show().removeClass('menu-fade-out');
      $('#startBtn').show().removeClass('menu-fade-out');
      
      // Hide landing elements
      $('.hero-section-typing').addClass('menu-fade-out');
      $('#startBtn').addClass('menu-fade-out');
      
      // Show mode selection after animation
      setTimeout(() => {

        $('.hero-section-typing').hide();
        $('#startBtn').hide();
        $('#grp1').show(); // Show the game section container
        
        // Force animation reset by removing class, forcing reflow, then adding back
        $('#modeSelectionSection').removeClass('text-reveal').css('opacity', '').css('transform', '').show();
        // Force reflow to ensure style reset takes effect
        $('#modeSelectionSection')[0].offsetHeight;
        $('#modeSelectionSection').addClass('text-reveal');

        
      }, 500);
    }

    // Long click functionality for keyboard icon
    let longClickTimer = null;
    let isLongClicking = false;

    function setupLongClick() {
      const keyboardIcon = document.getElementById('keyboardIcon');
      
      function startLongClick() {
        isLongClicking = true;
        longClickTimer = setTimeout(() => {
          if (isLongClicking) {
            openVersionModal();
          }
        }, 3000); // 3 seconds
      }

      function cancelLongClick() {
        isLongClicking = false;
        if (longClickTimer) {
          clearTimeout(longClickTimer);
          longClickTimer = null;
        }
      }

      // Mouse events
      keyboardIcon.addEventListener('mousedown', startLongClick);
      keyboardIcon.addEventListener('mouseup', cancelLongClick);
      keyboardIcon.addEventListener('mouseleave', cancelLongClick);

      // Touch events
      keyboardIcon.addEventListener('touchstart', startLongClick);
      keyboardIcon.addEventListener('touchend', cancelLongClick);
      keyboardIcon.addEventListener('touchcancel', cancelLongClick);
    }

    // Initialize long click when page loads
    $(document).ready(function() {
      setupLongClick();
    });

    function selectModeAndStart(modeNumber) {
      console.log('selectModeAndStart called with mode:', modeNumber);
      console.log('Stack trace:', new Error().stack);
      console.log('Current state when mode selected - started:', started, 'countingDown:', countingDown);
      
      // Set the mode
      changeMode(modeNumber);
      
      // Show countdown instead of starting immediately
      setTimeout(() => {
        showCountdown();
      }, 200);
    }

    function showCountdown() {
      console.log('showCountdown() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);
      
      // Hide mode selection
      $('#grp1').addClass('menu-fade-out');
      
      // Show countdown after animation
      setTimeout(() => {
        $('#grp1').hide();
        $('#countdownSection').show().addClass('text-reveal');
        startCountdownTimer();
      }, 500);
    }

    let countdownInterval;
    
    function startCountdownTimer() {
      let timeLeft = 5;
      const countdownNumber = document.getElementById('countdownNumber');
      const countdownBar = document.getElementById('countdownBar');
      
      // Reset bar width
      countdownBar.style.width = '100%';
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        countdownNumber.textContent = timeLeft;
        
        // Update progress bar
        const progressPercent = (timeLeft / 5) * 100;
        countdownBar.style.width = progressPercent + '%';
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          
          // Hide countdown and start game
          $('#countdownSection').addClass('menu-fade-out');
          setTimeout(() => {
            $('#countdownSection').hide().removeClass('text-reveal menu-fade-out');
            // Reset countdown for next time
            countdownNumber.textContent = '5';
            countdownBar.style.width = '100%';
            
            // Start game immediately without additional countdown
            startGameDirectly();
          }, 500);
        }
      }, 1000);
    }

    function retryGame() {
      console.log('Retrying game - going directly to mode selection...');
      console.log('Before reset - started:', started, 'countingDown:', countingDown, 'timerStartedOnce:', timerStartedOnce);
      
      // Clear ALL possible timers and intervals more aggressively
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      // Clear any potential setTimeout calls by getting the highest timeout ID and clearing them
      let highestTimeoutId = setTimeout(";");
      for (let i = 0; i < highestTimeoutId; i++) {
        clearTimeout(i);
      }
      
      // Reset only the game variables, not the UI state
      resetGameVariables();
      
      console.log('After reset - started:', started, 'countingDown:', countingDown, 'timerStartedOnce:', timerStartedOnce);
      
      // Close modal if open
      $('#testModal').modal('hide');
      
      // Go directly to mode selection (like clicking "ê²Œì„ ì‹œì‘") with a longer delay
      setTimeout(() => {
        console.log('Showing mode selection after retry...');
        showModeSelection();
      }, 800);
    }

    function resetGameVariables() {
      console.log('Resetting game variables only...');
      
      uuid = uuidv4();
      started = false;
      countingDown = false;
      progress = 0;
      secondsPassed = 0;
      keyPressCount = 0;
      keyPressCountTmp = 0;
      timeLimit = 60;
      scoreSaved = false;
      timerStartedOnce = false; // Reset timer state so it can start fresh
      
      // Reset smooth animation timer
      window.gameStartTime = null;
      
      correctWordCount = 0;
      incorrectWordCount = 0;
      score = 0;
      accuracy = 0;
      incWordArr = [];
      attmpWordArr = [];

      sentenceTriplet = [];
      prevInputSent = "";

      typedSentenceList = [];
      givenSentenceList = [];

      keyMap.clear();
      
      // Clear content and data attributes
      $('#testSentInput').html('').removeData('original-text');
      $('#testSentInputBefore').html('').removeData('original-text');
      $('#testSentInputAfter').html('').removeData('original-text');
      $('#chatInput').val('');
      
      // Reset progress bar
      var $progressBar = $(".progress-bar-modern");
      var $progressContainer = $(".progress-modern");
      $progressBar.removeClass('warning danger').css("width", "100%").text("60");
      $progressContainer.removeClass('warning danger');
      
      // Reset save form state
      resetSaveForm();
      
      // Clear any comment visibility
      $('#comment').css("visibility", "hidden");
      
      // Reset countdown display
      if (document.getElementById('countdownNumber')) {
        document.getElementById('countdownNumber').textContent = '5';
      }
      if (document.getElementById('countdownBar')) {
        document.getElementById('countdownBar').style.width = '100%';
      }
      
      // Clear animation classes from game elements
      $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
      $('#testSentInput').removeClass('text-reveal');
      $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
      $('#chatInput').removeClass('input-focus-ready');
      $('#grp2').removeClass('game-start-transition').hide();
      $('#countdownSection').hide().removeClass('text-reveal menu-fade-out');
      
      // Clear active mode selection
      $('.mode-card').removeClass('active');
      mode = null; // Reset mode variable
    }

    function startGameDirectly() {
      console.log('startGameDirectly() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);
      
      if(!started && !countingDown){
        console.log('Starting game directly after countdown...');
        
        // Show game area immediately
        $('#grp2').show().addClass('game-start-transition');
        
        // Prepare game content immediately - ensure fresh start
        console.log('Before updateSentenceTriplet in startGameDirectly - sentenceTriplet:', sentenceTriplet);
        sentenceTriplet = []; // Force clear to ensure fresh sentences
        updateSentenceTriplet();
        console.log('After updateSentenceTriplet in startGameDirectly - sentenceTriplet:', sentenceTriplet);
        
        // Clear any old data attributes and set new content
        $('#testSentInputBefore').removeData('original-text').html(sentenceTriplet[0]).data('original-text', sentenceTriplet[0]);
        $('#testSentInput').removeData('original-text').html(sentenceTriplet[1]).data('original-text', sentenceTriplet[1]);
        $('#testSentInputAfter').removeData('original-text').html(sentenceTriplet[2]).data('original-text', sentenceTriplet[2]);
        
        // Start the game immediately and ensure input is ready
        start();
        
        // Additional focus to ensure input is immediately responsive
        setTimeout(() => {
          $('#chatInput').focus();
        }, 100);
      } else {
        console.log('startGameDirectly blocked - started:', started, 'countingDown:', countingDown);
      }
    }

    function startGameCountdown(){
      console.log('startGameCountdown() called - this should NOT happen during retry!');
      console.log('Stack trace:', new Error().stack);

      if(!started && !countingDown){
        console.log('Starting countdown...');
        
        // Hide mode selection and show game area
        $('#modeSelectionSection').addClass('menu-fade-out');
        
        setTimeout(() => {
          $('#modeSelectionSection').hide();
          $('#grp2').show().addClass('game-start-transition');
        }, 300);
        
        countingDown = true;

        var counter = 5;
        
        var counterItv = setInterval(function(){ 
          counter-=1;
          
          if(counter==0){
            clearInterval(counterItv);
            countingDown = false;
            
            // Prepare game content - ensure fresh start
            console.log('Before updateSentenceTriplet in startGameCountdown - sentenceTriplet:', sentenceTriplet);
            sentenceTriplet = []; // Force clear to ensure fresh sentences
              updateSentenceTriplet();
            console.log('After updateSentenceTriplet in startGameCountdown - sentenceTriplet:', sentenceTriplet);
            
            // Clear any old data attributes and set new content
            $('#testSentInputBefore').removeData('original-text').html(sentenceTriplet[0]).data('original-text', sentenceTriplet[0]);
            $('#testSentInput').removeData('original-text').html(sentenceTriplet[1]).data('original-text', sentenceTriplet[1]);
            $('#testSentInputAfter').removeData('original-text').html(sentenceTriplet[2]).data('original-text', sentenceTriplet[2]);
            
            // Start the game
              start();
          }
        }, 1000);
      } else {
        // Debug: log why startCountDown is not executing
        console.log('startCountDown blocked - started:', started, 'countingDown:', countingDown);
      }
    }
    
    function start(){
      if(!started){
        started = true;
        
        // Debug: log timer state when starting
        console.log('Game starting - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
        
        // Focus input immediately for instant responsiveness
        $('#chatInput').focus();
        
        // Add reveal animations to content that's already visible (but don't delay input)
        setTimeout(() => {
          $('#testSentInputBefore').addClass('text-reveal-delay-1');
          $('#testSentInput').addClass('text-reveal');
          $('#testSentInputAfter').addClass('text-reveal-delay-2');
          // Don't add animation class to input to keep it immediately responsive
        }, 200);
        
        // Set up the game timer (only once)
        if(!timerStartedOnce){
          timerStartedOnce = true;

          // Initialize game start time for smooth animation
          window.gameStartTime = Date.now();

          // Main timer that updates every second
          setInterval(function(){ 
              if(started){
                  // Ensure input stays focused during gameplay
                  if(!$('#chatInput').is(':focus')) {
                  $('#chatInput').focus();
                  }
                  progress = secondsPassed/timeLimit * 100;  
                  var timeLeftVal = 100 - progress;
                  
                  // Dynamic color classes and container effects
                  var $progressBar = $(".progress-bar-modern");
                  var $progressContainer = $(".progress-modern");
                  
                  // Remove all dynamic classes first
                  $progressBar.removeClass('warning danger');
                  $progressContainer.removeClass('warning danger');
                  
                  if (progress >= 80) {
                    $progressBar.addClass('danger');
                    $progressContainer.addClass('danger');
                  } else if (progress >= 60) {
                    $progressBar.addClass('warning');
                    $progressContainer.addClass('warning');
                  }
                  
                  $progressBar.css("width", timeLeftVal + "%").text(timeLimit - secondsPassed);
                  
                  // Debug: log timer progress
                  if(secondsPassed % 10 === 0) {
                    console.log('Timer tick - secondsPassed:', secondsPassed, 'timeLimit:', timeLimit);
                  }
                  
                  secondsPassed+=1;
                  if(secondsPassed > timeLimit){
                    console.log('Timer ended - calling endLogic()');
                    endLogic();
                  }
              }
            }, 1000);
            
          // Smooth progress bar animation - updates every 100ms for smooth effect
          setInterval(function(){
              if(started){
                  // Calculate fractional progress for smooth animation
                  var currentTime = Date.now();
                  var elapsedMs = currentTime - window.gameStartTime;
                  var elapsedSeconds = elapsedMs / 1000;
                  var smoothProgress = elapsedSeconds / timeLimit * 100;
                  var smoothTimeLeftVal = 100 - smoothProgress;
                  
                  // Only update width for smooth animation, keep text from main timer
                  $(".progress-bar-modern").css("width", Math.max(0, smoothTimeLeftVal) + "%");
              }
          }, 100);
          }
        }
    }
    
    function endLogic(){
        if(started){
            started = false;

            // Hide game area
            $('#grp2').removeClass('game-start-transition').hide();
            
            // Clear all animation classes
            $('#testSentInputBefore').removeClass('text-reveal text-reveal-delay-1');
            $('#testSentInput').removeClass('text-reveal');
            $('#testSentInputAfter').removeClass('text-reveal text-reveal-delay-2');
            $('#chatInput').removeClass('input-focus-ready');
            
            // Clear content
            $('#testSentInput').html('');
            $('#testSentInputBefore').html('');
            $('#testSentInputAfter').html('');
            $('#chatInput').val('');

            // Show landing page again for retry
            setTimeout(() => {
                // Clear any countdown timer and hide all sections
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                $('#grp1').hide(); // Hide the game section container
                $('#countdownSection').hide().removeClass('text-reveal menu-fade-out'); // Hide countdown section
                
                $('.hero-section-typing').show().removeClass('menu-fade-out');
                $('#startBtn').show().removeClass('menu-fade-out').removeClass('countdown-pulse').html('<div class="mega-btn-bg"></div><div class="mega-btn-content"><div class="mega-btn-icon"><i class="fas fa-redo"></i></div><div class="mega-btn-text"><span class="mega-btn-title">ì¬ë„ì „</span><span class="mega-btn-subtitle">Try Again</span></div></div><div class="mega-btn-pulse"></div><div class="mega-btn-glow"></div>');
                $('#startBtn').attr('onclick', 'retryGame()');
                
                // Reset countdown display
                document.getElementById('countdownNumber').textContent = '5';
                document.getElementById('countdownBar').style.width = '100%';
            }, 500);

            accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
            score = Math.round((keyPressCount + getEffectiveKeyPressCountTmp()) * accuracy);
            if(mode==3||mode==4){
              score = Math.round(score/5);
            }

            checkRank();

            $('#resScore').text(score);
            $('#resGrade').text("[" + getGrade() + "]");
            $('#resAccuracy').text(Math.round(accuracy * 100) + "% (" + correctWordCount + "/" + (correctWordCount + incorrectWordCount) + ")");

            $('#incList').empty();
            for(var i=0; i<incWordArr.length; i++){
                //console.log((i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')");
                $('#incList').append('<li>' + (i+1) + ". " + incWordArr[i] + " ('" + attmpWordArr[i] + "')" + '</li>')
            }

            if(!isNaN(score)){
              addAnonHighscore(score, getGrade(), accuracy);
            }            

            $('#testModal').modal('show');
        }
    }

    function getEffectiveKeyPressCountTmp(){
      if(typedSentenceList.length == 0){
        return 0;
      } else {
        var avg = Math.round(keyPressCount / typedSentenceList.length);
        if(keyPressCountTmp > avg) {
          return avg;
        } else {
          return keyPressCountTmp;
        }
      }
    }

    function checkBatchimEnding(word) {
      if (typeof word !== 'string') return null;
    
      var lastLetter = word[word.length - 1];
      var uni = lastLetter.charCodeAt(0);
    
      if (uni < 44032 || uni > 55203) return null;
    
      return (uni - 44032) % 28 != 0;
    }

    function encounterMessage(name){
      var adj = checkBatchimEnding(name)?'ì´':'ê°€';
    }

    function generateName(){
      const f = ["ê¹€", "ë°•", "ì´", "ì¥", "ì„", "ì–‘", "í•œ", "ì„œ", "ì•ˆ"];
      const s = ["í˜•", "ë¯¼", "í¬", "ì£¼", "ì„±", "í˜¸", "ê´‘", "ì²œ", "ì„¸", "í›ˆ", "ì„", "ì˜", "ì€", "ì—°", "ê²½", "ê³ ", "ìš´", "ì†Œ", "í¬", "ì •"];

      return f[ri(f.length)] + s[ri(s.length)] + s[ri(s.length)];
    }
    
    function generateSentence(){
      startSentenceTime = new Date();

      var pnouns;
      var nouns;
      var verbs;
      var adjectives;

      if(mode == 1 || mode == 2){
        pnouns = [];
        pnouns.push(generateName());
      
        nouns = ["ê°ì","ê³¼ì","ì‚¬íƒ•","ë‚™íƒ€","ì»´í“¨í„°","í‚¤ë³´ë“œ","ë‹¤ëŒì¥","ê³µë£¡","ìŠ¬ë™","í•¸ë“œí°", "ì‚¬ì§„ê¸°","ë¬¼ì»µ", "ëª¨ë‹ˆí„°", "ì°½ê³ ", "ê°•ì•„ì§€", "ê³ ì–‘ì´", "ëƒ‰ì¥ê³ ", "ë‹¤ë¦¬ë¯¸", "ì»µ", "í¬í¬", "ìˆŸê°€ë½", "ëª…í•¨", "ê³°", "ê±°ë¶ì´", "í† ë¼", "ë¹—ìë£¨", "ì‡³ë©ì–´ë¦¬", "êµ¬ìŠ¬", "ìŠ¤íŠ¸ë ˆì¹­ ë„êµ¬", "ë§ˆì‚¬ì§€ ì˜ì", "ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°", "ìœ ì„  í•¸ë“œí°", "ëª…í’ˆ ê°€ë°©", "í•˜ì´í", "ëšœë ˆì¥¬ë¥´", "ê¸€ë£¨", "ì²´ë¦¬", "ì„œë²„", "ê²½ì§€ì‹¤", "ê²½ì „ì‹¤", "ì²´ë¦¬ ê°œë°œíŒ€", "ì•¼êµ¬ ë¹ ë”°", "ì›ìˆ­ì´", "ìƒì¥", "ì¹œêµ¬", "ì‚¬ëŒ", "ëª¨ë‹¥ë¶ˆ", "ì•„ì´ìŠ¤í¬ë¦¼", "ìŠ¤í…Œì´í¬", "ë¯¸êµ­ì‚° ê³ ê¸°", "ì‚´ì•„ìˆëŠ” í•œìš°", "ì†Œ", "ê°•ì•„ì§€", "ê³ ì–‘ì´"]
        
        verbs = ["ë¨¹ì—ˆë‹¤", "ë•Œë ¸ë‹¤","ì§¸ë ¤ë´¤ë‹¤","ê±·ì–´ ì°¼ë‹¤", "ì‹«ì–´í•œë‹¤", "ì¢‹ì•„í•œë‹¤", "í˜ì˜¤í•œë‹¤", "ê³µê²©í–ˆë‹¤", "ëŒë ¤ë²„ë ¸ë‹¤", "ì‹œë„í–ˆë‹¤", "ë°•ì‚´ëƒˆë‹¤", "ì‹¸ëŒ€ê¸° ë•Œë ¸ë‹¤", "ë°˜í† ë§‰ëƒˆë‹¤", "ì³ë‹¤ë´¤ë‹¤", "íŒ¨ë²„ë ¸ë‹¤", "ìƒìƒí•´ë´¤ë‹¤", "ê°ˆê¶œë‹¤", "ë¿Œë¦¬ì³¤ë‹¤", "ê¹¨ë¬¼ì–´ë²„ë ¸ë‹¤", "ê°œë°œí–ˆë‹¤", "í•´í‚¹í–ˆë‹¤", "ë§í•˜ê²Œ í•´ë²„ë ¸ë‹¤", "ë§ê°€íŠ¸ë ¸ë‹¤", "ìœ„ì¡°í–ˆë‹¤", "ê¸°ë¶€í–ˆë‹¤", "ë°€ì–´ ëƒˆë‹¤", "ì¡ì•„ ë‹¹ê²¼ë‹¤", "ìš•í–ˆë‹¤"]

        adjectives = ["ë§›ìˆê²Œ", "í˜ì°¨ê²Œ", "ê²¨ìš°", "ì²œì²œíˆ", "ë©‹ìˆê²Œ", "ì˜ˆì˜ê²Œ", "ë¹ ë¥´ê²Œ", "ëœ¨ê²ê²Œ", "ì´ìƒí•˜ê²Œ", "ê·€ì—½ê²Œ", "ë”°ëˆí•˜ê²Œ","ì–„ë°‰ê²Œ", "ì°¨ê°‘ê²Œ", "ì–´ì¤‘ê°„í•˜ê²Œ", "ì–´ìƒ‰í•˜ê²Œ", "ë˜‘ë˜‘í•˜ê²Œ", "ì²œì¬ ì²˜ëŸ¼", "í• ë“¯ ë§ë“¯", "ëšœì‰ìŠ¤ëŸ½ê²Œ", "ì°°ì§€ê²Œ", "ë¬´ì„­ê²Œ"];
        if(mode == 2){
          pnouns = ["ì´ì†Œí¬ ì‚¬ì›ë‹˜", "ì „í•˜ì˜ ì‚¬ì›ë‹˜", "ì¥ì£¼í™˜ ì£¼ì„ë‹˜", "ê¹€ì„ì£¼ ì£¼ì„ë‹˜", "ê¹€ë¯¼í˜•", "ì–‘ì„¸í›ˆ","ì„í¬ì£¼ ì£¼ì„ë‹˜","ì„œì˜ì€ ê³¼ì¥ë‹˜","ì•ˆìƒì¤€ ëŒ€ë¦¬ë‹˜", "ë°•ì„±í˜¸ ì†Œì¥ë‹˜", "ê¹€ê´‘ì²œ ì´ì‚¬ë‹˜", "í•œì„¸í›ˆ ì´ì‚¬ë‹˜", "ë°•ì—°ê²½ ì°¨ì¥ë‹˜", "ì´ë¯¸ì£¼"];
          adjectives.push("ì„í¬ì£¼ ë‹µê²Œ");
        }
      } else if(mode == 3){
        var engSent = "";
        for(var l=0; l<7; l++){
          var engWord = getWord();
          while(engSent.includes(engWord)){
            engWord = getWord();
          }
          engSent += engWord + (l==6 ? '' : ' ');
        }
        return engSent;
      } else if(mode==4){
        return getPrgSent();
      }

      var sent = ""

      var pnoun = pnouns[ri(pnouns.length)];
      var noun =  nouns[ri(nouns.length)];
      var adjective = adjectives[ri(adjectives.length)];
      var verb = verbs[ri(verbs.length)];

      sent += pnoun + (checkBatchimEnding(pnoun)? "ì€ " : "ëŠ” ") + noun + (checkBatchimEnding(noun)? "ì„ " : "ë¥¼ ") + adjective + " " + verb;
      sent += ".";

      // if(Math.random() < 0.01){
      //   sent = "ì„í¬ì£¼ëŠ” ìƒë‹¹íˆ í­ë ¥ì ì´ë‹¤. ì¡°ì‹¬í•´ë¼. í•­ìƒ.";
      // }
      
      // if(Math.random() < 0.01){
      //   sent = "ê°‘ìê¸° ì˜íƒ€ ì‹œí—˜ ê³ ê³  abcdefghijklmnopqrstuvwxyz";
      // }

      return sent;
    }
    
    function updateScore(){
        var splitProb = $('#testSentInput').text().split(' ');
        var splitAns = $('#chatInput').val().split(' ');
        
        //var length = splitProb.length > splitAns.length ? splitAns.length : splitProb.length;
        
        for(var i=0; i<splitProb.length; i++){
            var eq = false;
            for(var j=0; j<splitAns.length; j++){
                if(splitProb[i] == splitAns[j]){
                    eq = true;
                    correctWordCount+=1;
                    break;
                }
            }
            if(!eq){
                var atmp = i >= splitAns.length ? '?' : splitAns[i];
                attmpWordArr.push(atmp);
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }

        var sentenceEndDate = new Date();
        var setenceSecondsElapsed = Math.round((sentenceEndDate - startSentenceTime)/1000);

        $('#comment').text(getComment());
        $('#comment').css("visibility", "visible");
        $('#comment').addClass('comment-fade-in')
        $('#comment').on("animationend", function(){
          $(this).css("visibility", "hidden");
          $(this).removeClass('comment-fade-in');
        });

        
        
        /*
        for(var i=0; i< length; i++){
            if(splitProb[i] == splitAns[i]){
                correctWordCount+=1;
            } else {
                incWordArr.push(splitProb[i]);
                incorrectWordCount+=1;
            }
        }
        */
    }

    function getComment(){
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }

      var tmpAccuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      var tmpScore = Math.round(keyPressCount * timeLimit/secondsPassed * tmpAccuracy);
      if(mode==3||mode==4){
        tmpScore = Math.round(tmpScore/5);
      }
        
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(tmpScore < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }

    function getGrade(){
      //accuracy = correctWordCount / (correctWordCount + incorrectWordCount);
      //score = Math.round(keyPressCount * timeLimit/secondsPassed * accuracy);
        
      var arr = [];
      switch(mode){
        case 1: arr = level; break;
        case 2: arr = level; break;
        case 3: arr = englevel; break;
        case 4: arr = prglevel; break;
        default: break;
      }
      var grade = '';
      for(var z=0; z<arr.length; z++){
          if(score < arr[z].s){
              grade = arr[z].l;
              break;
          }
      }

      return grade;
    }
    
    // Enhanced word-aware text highlighting functions
    function highlightText(element, searchText) {
      if (!searchText) {
        return;
      }
      
      var $el = $(element);
      var originalText = $el.data('original-text') || $el.text();
      
      // Store original text if not already stored
      if (!$el.data('original-text')) {
        $el.data('original-text', originalText);
      }
      
      // Split both texts into words, preserving spaces
      var targetWords = originalText.split(' ');
      var typedWords = searchText.split(' ');
      
      var highlightedText = '';
      
      for (var i = 0; i < targetWords.length; i++) {
        var targetWord = targetWords[i];
        var typedWord = typedWords[i] || '';
        
        if (i < typedWords.length - 1) {
          // Complete word (user has moved past this word by typing a space)
          if (typedWord === targetWord) {
            // Correct complete word
            highlightedText += '<mark class="word-correct">' + targetWord + '</mark>';
          } else {
            // Incorrect complete word
            highlightedText += '<mark class="word-incorrect">' + targetWord + '</mark>';
          }
        } else if (i === typedWords.length - 1 && typedWord.length > 0) {
          // Current word being typed
          if (typedWord === targetWord) {
            // Word is complete and correct - mark it green immediately!
            highlightedText += '<mark class="word-correct">' + targetWord + '</mark>';
          } else if (targetWord.startsWith(typedWord)) {
            // Partial match - highlight the typed part
            var typedPart = targetWord.substring(0, typedWord.length);
            var remainingPart = targetWord.substring(typedWord.length);
            highlightedText += '<mark class="word-partial">' + typedPart + '</mark>' + remainingPart;
          } else {
            // Wrong typing in current word
            var matchLength = 0;
            // Find how much of the beginning matches
            for (var j = 0; j < Math.min(typedWord.length, targetWord.length); j++) {
              if (typedWord[j] === targetWord[j]) {
                matchLength++;
              } else {
                break;
              }
            }
            
            if (matchLength > 0) {
              var correctPart = targetWord.substring(0, matchLength);
              var wrongPart = targetWord.substring(matchLength, typedWord.length);
              var remainingPart = targetWord.substring(typedWord.length);
              
              highlightedText += '<mark class="word-partial">' + correctPart + '</mark>';
              if (wrongPart.length > 0) {
                highlightedText += '<mark class="word-error">' + wrongPart + '</mark>';
              }
              highlightedText += remainingPart;
            } else {
              // Completely wrong from the start
              var wrongLength = Math.min(typedWord.length, targetWord.length);
              var wrongPart = targetWord.substring(0, wrongLength);
              var remainingPart = targetWord.substring(wrongLength);
              highlightedText += '<mark class="word-error">' + wrongPart + '</mark>' + remainingPart;
            }
          }
        } else {
          // Untyped word
          highlightedText += targetWord;
        }
        
        // Add space between words (except for the last word)
        if (i < targetWords.length - 1) {
          highlightedText += ' ';
        }
      }
      
      // Update the element content
      $el.html(highlightedText);
    }

    function removeHighlight(element) {
      var $el = $(element);
      var originalText = $el.data('original-text');
      
      if (originalText) {
        // Restore original text
        $el.text(originalText);
      } else {
        // If no original text stored, remove mark tags manually and store clean text
        var cleanText = $el.text(); // Get text without HTML
        $el.find('mark').each(function() {
          $(this).replaceWith($(this).text());
        });
        // Store the clean text for future use
        $el.data('original-text', cleanText);
      }
    }

    // jQuery plugin style functions for compatibility (defined globally)
    // Ensure jQuery is available before defining plugins
    if (typeof jQuery !== 'undefined') {
      $.fn.mark = function(searchText) {
        return this.each(function() {
          highlightText(this, searchText);
        });
      };

      $.fn.unmark = function() {
        return this.each(function() {
          removeHighlight(this);
        });
      };
      
      console.log('Custom mark.js replacement loaded successfully');
    } else {
      console.error('jQuery not available, cannot define mark/unmark functions');
    }
    
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    document.addEventListener('keydown', event => {
      if(started){
        keyPressCountTmp+=1;
        const keyCode = event.code;

        if(keyCode != "Backspace"){
          cheatDetect.push(keyCode);
        
          //cheat detection
          if(cheatDetect.length >= 10){
            cheatDetect.shift();

            var cheating = true;
            for(var z = 1; z < cheatDetect.length; z++){
              if(cheatDetect[z-1] != cheatDetect[z]){
                cheating = false;
                break;
              }
            }
            if(cheating){
              alert("[ì ìˆ˜ ì¡°ì‘ ë°©ì§€ ì•Œë¦¼]");
            }
          }
        }

        if(keyMap.has(keyCode)){
          keyMap.set(keyCode, keyMap.get(keyCode) + 1);
        } else {
          keyMap.set(keyCode, 1);
        }
        
        if(keyCode=="Enter"){
          console.log('Enter pressed - updating sentences');
          keyPressCount += keyPressCountTmp;
          keyPressCountTmp = 0;
          updateScore();
          
          // IMPORTANT: Capture current input before updating sentences
          var currentTypedInput = $('#chatInput').val();
          
          console.log('Before updateSentenceTriplet:', sentenceTriplet);
          updateSentenceTriplet();
          console.log('After updateSentenceTriplet:', sentenceTriplet);
          
          givenSentenceList.push(sentenceTriplet[2]);
          typedSentenceList.push(currentTypedInput);

          // Update content for Before and Current sections (normal text)
          $('#testSentInputBefore').html(sentenceTriplet[0]);
          $('#testSentInput').html(sentenceTriplet[1]);
          
          // For After section: Set plain text first, then apply highlighting
          $('#testSentInputAfter').html(sentenceTriplet[2]);
          
          // Store original text for highlighting purposes after content update
          $('#testSentInputBefore').data('original-text', sentenceTriplet[0]);
          $('#testSentInput').data('original-text', sentenceTriplet[1]);
          $('#testSentInputAfter').data('original-text', sentenceTriplet[2]);
          
          console.log('Updated HTML content:');
          console.log('Before:', sentenceTriplet[0]);
          console.log('Current:', sentenceTriplet[1]);
          console.log('After:', sentenceTriplet[2]);
          console.log('Current typed input:', currentTypedInput);
          
          // Apply highlighting to the After section with the current input that just finished
          removeHighlight($("#testSentInputAfter")[0]);
          if (currentTypedInput && currentTypedInput.trim() !== '') {
            console.log('Applying highlight to After section with:', currentTypedInput);
            highlightText($("#testSentInputAfter")[0], currentTypedInput);
          }
          
          // Update prevInputSent for future reference (though we don't use it for After section now)
          prevInputSent = currentTypedInput;
          $('#chatInput').val("");
          
          // Clear any existing highlighting on the new current sentence
          removeHighlight($("#testSentInput")[0]);
        }
      }
    });

    // Handle real-time highlighting during typing using input event (fires AFTER value changes)
    document.addEventListener('input', event => {
      if(started && event.target && event.target.id === 'chatInput' && sentenceTriplet.length >= 2){
        console.log('Input event triggered - highlighting current sentence');
        removeHighlight($("#testSentInput")[0]);
        var totalInput = event.target.value;
        if (totalInput && totalInput.trim() !== '') {
          highlightText($("#testSentInput")[0], totalInput);
        }
      }
    });
});
    </script>


  <!-- Removed duplicate jQuery loads to fix mark.js conflicts -->
  <script src="js/transit.js"></script>  
  <script src="js/sent_generator.js"></script> 
  <script src="js/sent_generator_kr.js"></script> 
  <script src="js/prg_sent.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/ko.js"></script>
    <!-- Removed duplicate popper, bootstrap, and mark.js - now loaded in head -->
    <script src="data/adjectives.js"></script>
    <script src="data/verbs.js"></script>
    <script src="data/nouns.js"></script>
    <script src="data/simple_words.js"></script>
  </body>
</html>
